<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Services - Provider Dashboard</title>
    <link rel="icon" type="image/webp" href="/assets/images/logo.webp" />
    <link rel="stylesheet" href="../assets/css/style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Dashboard Header Styles */
      .dashboard-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: white;
        border-bottom: 1px solid #e5e7eb;
        z-index: 100;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }

      .dashboard-header .container {
        max-width: 100%;
        padding: 0 30px;
      }

      .dashboard-navbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        height: 70px;
        gap: 30px;
      }

      .dashboard-logo {
        display: flex;
        align-items: center;
        gap: 12px;
        text-decoration: none;
        font-weight: 700;
        font-size: 1.3rem;
        color: var(--text-dark);
      }

      .dashboard-logo img {
        height: 38px;
        width: auto;
      }

      .dashboard-search {
        flex: 1;
        max-width: 500px;
        position: relative;
      }

      .dashboard-search input {
        width: 100%;
        padding: 10px 20px 10px 45px;
        border: 1px solid #e5e7eb;
        border-radius: 25px;
        background: #f9fafb;
        outline: none;
        transition: all 0.3s;
        font-size: 0.95rem;
      }

      .dashboard-search input:focus {
        background: white;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(0, 201, 167, 0.1);
      }

      .dashboard-search i {
        position: absolute;
        left: 18px;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
        font-size: 0.9rem;
      }

      .dashboard-actions {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .dashboard-icon-btn {
        position: relative;
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: #f9fafb;
        border: none;
        display: grid;
        place-items: center;
        cursor: pointer;
        transition: all 0.2s;
        color: #6b7280;
      }

      .dashboard-icon-btn:hover {
        background: #f3f4f6;
        color: var(--primary-color);
      }

      .dashboard-icon-btn .badge-dot {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 8px;
        height: 8px;
        background: #ef4444;
        border-radius: 50%;
        border: 2px solid white;
      }

      .user-menu {
        position: relative;
      }

      .user-menu-trigger {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 6px 12px 6px 6px;
        border-radius: 25px;
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        cursor: pointer;
        transition: all 0.2s;
      }

      .user-menu-trigger:hover {
        background: #f3f4f6;
        border-color: #d1d5db;
      }

      .user-menu-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .user-menu-info {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
      }

      .user-menu-name {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-dark);
        line-height: 1.2;
      }

      .user-menu-role {
        font-size: 0.75rem;
        color: #6b7280;
      }

      .user-menu-chevron {
        color: #9ca3af;
        font-size: 0.75rem;
      }

      .user-dropdown {
        position: absolute;
        top: calc(100% + 10px);
        right: 0;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        min-width: 220px;
        padding: 8px 0;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.3s;
        z-index: 1000;
      }

      .user-menu.active .user-dropdown {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .user-dropdown-header {
        padding: 12px 16px;
        border-bottom: 1px solid #f3f4f6;
        margin-bottom: 8px;
      }

      .user-dropdown-name {
        font-weight: 600;
        font-size: 0.95rem;
        color: var(--text-dark);
        margin-bottom: 2px;
      }

      .user-dropdown-email {
        font-size: 0.8rem;
        color: #6b7280;
      }

      .user-dropdown a {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 16px;
        color: #4b5563;
        text-decoration: none;
        transition: all 0.2s;
      }

      .user-dropdown a:hover {
        background: #f9fafb;
        color: var(--primary-color);
      }

      .user-dropdown a i {
        width: 18px;
        text-align: center;
        font-size: 0.9rem;
      }

      .user-dropdown-divider {
        height: 1px;
        background: #f3f4f6;
        margin: 8px 0;
      }

      .user-dropdown a.logout {
        color: #ef4444;
      }

      .user-dropdown a.logout:hover {
        background: #fef2f2;
      }

      @media (max-width: 768px) {
        .dashboard-search {
          display: none;
        }

        .user-menu-info {
          display: none;
        }

        .dashboard-header .container {
          padding: 0 20px;
        }
      }

      /* Dashboard Layout Styles */
      .provider-dashboard {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
        padding-top: 80px;
      }
      .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 30px 20px;
      }
      .dashboard-layout {
        display: grid;
        grid-template-columns: 280px 1fr;
        gap: 30px;
      }
      @media (max-width: 992px) {
        .dashboard-layout {
          grid-template-columns: 1fr;
        }
        .provider-sidebar {
          display: none; /* Hide sidebar on mobile, use hamburger menu instead or a bottom nav */
        }
      }
      /* Sidebar */
      .provider-sidebar {
        background: white;
        border-radius: 20px;
        padding: 0;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
        height: fit-content;
        position: sticky;
        top: 100px;
      }
      .provider-profile-card {
        padding: 30px 20px;
        text-align: center;
        border-bottom: 1px solid var(--border-color);
      }
      .provider-avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        margin: 0 auto 15px;
        border: 4px solid var(--primary-color);
        object-fit: cover;
        box-shadow: 0 5px 20px rgba(0, 201, 167, 0.2);
      }
      .provider-profile-card h3 {
        margin: 0 0 5px;
        font-size: 1.2rem;
        color: var(--text-dark);
      }
      .provider-profile-card .badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-top: 8px;
      }
      .badge-verified {
        background: linear-gradient(135deg, #22c55e, #16a34a);
        color: white;
      }
      .badge-pending {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
      }
      .sidebar-nav {
        padding: 15px 0;
      }
      .sidebar-nav a {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 25px;
        color: var(--text-light);
        transition: all 0.3s ease;
        font-weight: 500;
        border-left: 3px solid transparent;
        text-decoration: none;
      }
      .sidebar-nav a:hover,
      .sidebar-nav a.active {
        background: rgba(0, 201, 167, 0.08);
        color: var(--primary-color);
        border-left-color: var(--primary-color);
      }
      .sidebar-nav a i {
        width: 20px;
        text-align: center;
      }
      /* Content */
      .content-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
      }
      .content-header h1 {
        font-size: 1.8rem;
        color: var(--text-dark);
        margin: 0;
      }
      /* Service Card Styles */
      .service-card {
        background: white;
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        transition: transform 0.3s ease;
      }
      .service-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      }
      .service-image {
        width: 180px;
        height: 120px;
        border-radius: 12px;
        object-fit: cover;
      }
      .service-details {
        flex: 1;
      }
      .service-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
      }
      .service-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--text-dark);
        margin: 0;
      }
      .service-price {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--primary-color);
      }
      .service-desc {
        color: var(--text-light);
        font-size: 0.95rem;
        margin-bottom: 15px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      .service-meta {
        display: flex;
        gap: 20px;
        color: var(--text-light);
        font-size: 0.9rem;
      }
      .service-actions {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: flex-end;
      }
      .status-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
        cursor: pointer;
      }
      .status-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: #ccc;
      }
      .status-active .status-indicator {
        background-color: #22c55e;
      }
      .action-buttons {
        display: flex;
        gap: 10px;
      }
      .btn-icon {
        width: 35px;
        height: 35px;
        border-radius: 8px;
        display: grid;
        place-items: center;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
      }
      .btn-edit {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
      }
      .btn-delete {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
      }
      .btn-edit:hover {
        background: #3b82f6;
        color: white;
      }
      .btn-delete:hover {
        background: #ef4444;
        color: white;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header class="dashboard-header">
      <div class="container">
        <nav class="dashboard-navbar">
          <a href="provider-dashboard.html" class="dashboard-logo">
            <img src="../logo.png" alt="Moueene Logo" />
          </a>

          <div class="dashboard-search">
            <i class="fas fa-search"></i>
            <input
              type="text"
              placeholder="Search services, bookings, customers..."
            />
          </div>

          <div class="dashboard-actions">
            <button
              class="dashboard-icon-btn"
              id="notifications-btn"
              title="Notifications"
            >
              <i class="fas fa-bell"></i>
              <span class="badge-dot"></span>
            </button>

            <button class="dashboard-icon-btn" title="Messages">
              <i class="fas fa-envelope"></i>
            </button>

            <div class="user-menu" id="user-menu">
              <div class="user-menu-trigger">
                <img
                  src="https://ui-avatars.com/api/?name=Provider&background=00c9a7&color=fff&size=36"
                  alt="User"
                  class="user-menu-avatar"
                  id="header-avatar"
                />
                <div class="user-menu-info">
                  <div class="user-menu-name" id="header-user-name">
                    Loading...
                  </div>
                  <div class="user-menu-role">Service Provider</div>
                </div>
                <i class="fas fa-chevron-down user-menu-chevron"></i>
              </div>

              <div class="user-dropdown">
                <div class="user-dropdown-header">
                  <div class="user-dropdown-name" id="dropdown-user-name">
                    Loading...
                  </div>
                  <div class="user-dropdown-email" id="dropdown-user-email">
                    email@example.com
                  </div>
                </div>
                <a href="provider-settings.html">
                  <i class="fas fa-user"></i>
                  <span>My Profile</span>
                </a>

                <a href="provider-earnings.html">
                  <i class="fas fa-wallet"></i>
                  <span>Earnings</span>
                </a>
                <div class="user-dropdown-divider"></div>
                <a href="#" class="logout" id="header-logout-btn">
                  <i class="fas fa-sign-out-alt"></i>
                  <span>Logout</span>
                </a>
              </div>
            </div>
          </div>
        </nav>
      </div>
    </header>

    <div class="provider-dashboard">
      <div class="dashboard-container">
        <div class="dashboard-layout">
          <!-- Sidebar -->
          <aside class="provider-sidebar">
            <div class="provider-profile-card">
              <img
                id="provider-avatar"
                src="https://ui-avatars.com/api/?name=Provider&background=00c9a7&color=fff&size=100"
                alt="Provider Avatar"
                class="provider-avatar"
              />
              <h3 id="provider-name">Loading...</h3>
              <p
                style="
                  color: var(--text-light);
                  font-size: 0.85rem;
                  margin: 5px 0;
                "
              >
                Service Provider
              </p>
              <span class="badge badge-pending" id="verification-badge">
                <i class="fas fa-clock"></i> Pending Verification
              </span>
            </div>

            <nav class="sidebar-nav">
              <a href="provider-dashboard.html" class="">
                <i class="fas fa-th-large"></i>
                <span>Dashboard</span>
              </a>
              <a href="provider-services.html" class="active">
                <i class="fas fa-briefcase"></i>
                <span>My Services</span>
              </a>
              <a href="provider-bookings.html" class="">
                <i class="fas fa-calendar-alt"></i>
                <span>Bookings</span>
              </a>
              <a href="provider-messages.html" class="">
                <i class="fas fa-envelope"></i>
                <span>Messages</span>
              </a>
              <a href="provider-reviews.html" class="">
                <i class="fas fa-star"></i>
                <span>Reviews</span>
              </a>
              <a href="provider-earnings.html" class="">
                <i class="fas fa-wallet"></i>
                <span>Earnings</span>
              </a>
              <a href="provider-settings.html" class="">
                <i class="fas fa-user-edit"></i>
                <span>Settings</span>
              </a>
              <a href="#" id="logout-btn">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
              </a>
            </nav>
          </aside>

          <!-- Main Content -->
          <main class="provider-main">
            <div class="content-header">
              <h1>My Services</h1>
              <button class="btn btn-primary" onclick="openAddServiceModal()">
                <i class="fas fa-plus"></i> Add New Service
              </button>
            </div>

            <!-- Services List -->
            <div class="services-list" id="services-list">
              <div class="loading" style="text-align: center; padding: 60px">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem"></i>
                <p style="margin-top: 12px; color: var(--text-light)">
                  Loading your services...
                </p>
              </div>
            </div>
          </main>
        </div>
      </div>
    </div>

    <!-- Add Service Modal -->
    <div id="add-service-modal" class="modal-overlay" style="display: none">
      <div
        class="modal-card"
        role="dialog"
        aria-modal="true"
        aria-labelledby="add-service-title"
      >
        <div class="modal-header">
          <div>
            <h2 id="add-service-title">Add a Service</h2>
            <p class="modal-subtitle">
              Choose a service from the catalog and set your pricing.
            </p>
          </div>
          <button
            class="modal-close"
            type="button"
            onclick="closeAddServiceModal()"
            aria-label="Close"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>

        <div class="modal-body">
          <div class="modal-grid">
            <div class="modal-panel">
              <label class="field-label" for="add-category">Category</label>
              <select id="add-category" class="field-input"></select>

              <label class="field-label" for="add-search">Search</label>
              <div class="field-with-icon">
                <i class="fas fa-search"></i>
                <input
                  id="add-search"
                  class="field-input"
                  type="text"
                  placeholder="Search services..."
                />
              </div>

              <label class="field-label" for="add-service-select"
                >Service</label
              >
              <select
                id="add-service-select"
                class="field-input"
                size="8"
              ></select>
              <div
                id="add-service-error"
                class="field-error"
                style="display: none"
              ></div>
            </div>

            <div class="modal-panel">
              <div id="service-preview" class="service-preview">
                <div class="service-preview__placeholder">
                  <i class="fas fa-layer-group"></i>
                  <p>Select a service to see details</p>
                </div>
              </div>

              <div class="form-row">
                <div>
                  <label class="field-label" for="add-price">Your Price</label>
                  <input
                    id="add-price"
                    class="field-input"
                    type="number"
                    min="0"
                    step="0.01"
                    placeholder="0.00"
                  />
                  <div
                    id="add-price-error"
                    class="field-error"
                    style="display: none"
                  ></div>
                </div>
                <div>
                  <label class="field-label" for="add-price-type"
                    >Price Type</label
                  >
                  <select id="add-price-type" class="field-input">
                    <option value="fixed">Fixed</option>
                    <option value="hourly">Hourly</option>
                    <option value="per_item">Per Item</option>
                    <option value="custom">Custom</option>
                  </select>
                </div>
              </div>

              <label class="field-label" for="add-description"
                >Your Description (optional)</label
              >
              <textarea
                id="add-description"
                class="field-input"
                rows="3"
                placeholder="Describe what you offer, what's included, etc."
              ></textarea>

              <label class="toggle-row">
                <input id="add-is-active" type="checkbox" checked />
                <span>
                  <strong>Active</strong>
                  <small>Make this service visible to customers.</small>
                </span>
              </label>

              <div style="margin-top: 14px">
                <label class="field-label" for="add-images"
                  >Service Images (optional)</label
                >
                <input
                  id="add-images"
                  class="field-input"
                  type="file"
                  accept="image/*"
                  multiple
                />
                <small
                  style="
                    display: block;
                    color: var(--text-light);
                    margin-top: 6px;
                  "
                >
                  Upload up to 5 images (JPG/PNG/WebP). These will be shown to
                  customers.
                </small>
                <div
                  id="add-images-preview"
                  style="
                    display: flex;
                    gap: 10px;
                    flex-wrap: wrap;
                    margin-top: 10px;
                  "
                ></div>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button
            class="btn btn-outline"
            type="button"
            onclick="closeAddServiceModal()"
          >
            Cancel
          </button>
          <button
            id="add-service-submit"
            class="btn btn-primary"
            type="button"
            onclick="submitAddService()"
          >
            <span class="btn-label">Add Service</span>
            <span class="btn-spinner" style="display: none"
              ><i class="fas fa-spinner fa-spin"></i
            ></span>
          </button>
        </div>
      </div>
    </div>

    <!-- Edit Service Modal -->
    <div id="edit-service-modal" class="modal-overlay" style="display: none">
      <div
        class="modal-card"
        role="dialog"
        aria-modal="true"
        aria-labelledby="edit-service-title"
      >
        <div class="modal-header">
          <div>
            <h2 id="edit-service-title">Edit Service</h2>
            <p class="modal-subtitle">
              Update your pricing, description, and status.
            </p>
          </div>
          <button
            class="modal-close"
            type="button"
            onclick="closeEditServiceModal()"
            aria-label="Close"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>

        <div class="modal-body">
          <div class="modal-grid">
            <div class="modal-panel">
              <div id="edit-service-preview" class="service-preview"></div>
            </div>

            <div class="modal-panel">
              <div class="form-row">
                <div>
                  <label class="field-label" for="edit-price">Your Price</label>
                  <input
                    id="edit-price"
                    class="field-input"
                    type="number"
                    min="0"
                    step="0.01"
                    placeholder="0.00"
                  />
                  <div
                    id="edit-price-error"
                    class="field-error"
                    style="display: none"
                  ></div>
                </div>
                <div>
                  <label class="field-label" for="edit-price-type"
                    >Price Type</label
                  >
                  <select id="edit-price-type" class="field-input">
                    <option value="fixed">Fixed</option>
                    <option value="hourly">Hourly</option>
                    <option value="per_item">Per Item</option>
                    <option value="custom">Custom</option>
                  </select>
                </div>
              </div>

              <label class="field-label" for="edit-description"
                >Your Description (optional)</label
              >
              <textarea
                id="edit-description"
                class="field-input"
                rows="3"
                placeholder="Describe what you offer, what's included, etc."
              ></textarea>

              <label class="toggle-row">
                <input id="edit-is-active" type="checkbox" />
                <span>
                  <strong>Active</strong>
                  <small>Make this service visible to customers.</small>
                </span>
              </label>

              <div style="margin-top: 14px">
                <label class="field-label" for="edit-images"
                  >Images (optional)</label
                >
                <input
                  id="edit-images"
                  class="field-input"
                  type="file"
                  accept="image/*"
                  multiple
                />
                <div
                  id="edit-images-preview"
                  style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px"
                ></div>
                <small style="display:block; margin-top:8px; color: var(--text-light)"
                  >Upload up to 10 images. Remove images to delete them from your
                  offering.</small
                >
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button
            class="btn btn-outline"
            type="button"
            onclick="closeEditServiceModal()"
          >
            Cancel
          </button>
          <button
            id="edit-service-submit"
            class="btn btn-primary"
            type="button"
            onclick="submitEditService()"
          >
            <span class="btn-label">Save Changes</span>
            <span class="btn-spinner" style="display: none"
              ><i class="fas fa-spinner fa-spin"></i
            ></span>
          </button>
        </div>
      </div>
    </div>

    <!-- Delete Confirm Modal -->
    <div id="delete-service-modal" class="modal-overlay" style="display: none">
      <div
        class="modal-card"
        role="dialog"
        aria-modal="true"
        aria-labelledby="delete-service-title"
        style="max-width: 560px"
      >
        <div class="modal-header">
          <div>
            <h2 id="delete-service-title">Delete Service</h2>
            <p class="modal-subtitle">
              This removes the service from your profile.
            </p>
          </div>
          <button
            class="modal-close"
            type="button"
            onclick="closeDeleteServiceModal()"
            aria-label="Close"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>

        <div class="modal-body">
          <div class="modal-panel" style="background: #fff">
            <p
              id="delete-service-message"
              style="margin: 0; color: rgba(15, 23, 42, 0.82)"
            ></p>
          </div>
        </div>

        <div class="modal-footer">
          <button
            class="btn btn-outline"
            type="button"
            onclick="closeDeleteServiceModal()"
          >
            Cancel
          </button>
          <button
            id="delete-service-submit"
            class="btn btn-primary"
            type="button"
            onclick="confirmDeleteService()"
            style="background: #ef4444"
          >
            <span class="btn-label">Delete</span>
            <span class="btn-spinner" style="display: none"
              ><i class="fas fa-spinner fa-spin"></i
            ></span>
          </button>
        </div>
      </div>
    </div>

    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/provider-ui.js"></script>
    <script src="../assets/js/main.js"></script>
    <script>
      // Minimal styling for the modal (kept local to this page)
      (function injectModalStyles() {
        const style = document.createElement("style");
        style.textContent = `
          .modal-overlay{position:fixed;inset:0;background:rgba(15,23,42,.55);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;padding:22px;z-index:9998}
          .modal-card{width:min(980px,100%);background:#fff;border-radius:18px;box-shadow:0 30px 80px rgba(2,6,23,.35);overflow:hidden}
          .modal-header{display:flex;align-items:flex-start;justify-content:space-between;gap:18px;padding:18px 20px;border-bottom:1px solid rgba(15,23,42,.08)}
          .modal-header h2{margin:0;font-size:1.35rem;color:var(--text-dark)}
          .modal-subtitle{margin:6px 0 0;color:var(--text-light);font-size:.95rem}
          .modal-close{border:none;background:rgba(15,23,42,.06);width:40px;height:40px;border-radius:12px;cursor:pointer;display:flex;align-items:center;justify-content:center}
          .modal-close:hover{background:rgba(15,23,42,.10)}
          .modal-body{padding:18px 20px}
          .modal-grid{display:grid;grid-template-columns:1fr 1.25fr;gap:16px}
          .modal-panel{background:rgba(248,250,252,.9);border:1px solid rgba(15,23,42,.08);border-radius:14px;padding:14px}
          .field-label{display:block;margin:10px 0 6px;color:var(--text-dark);font-weight:600;font-size:.92rem}
          .field-input{width:100%;padding:12px 12px;border-radius:12px;border:1px solid rgba(15,23,42,.12);background:#fff;outline:none}
          .field-input:focus{border-color:rgba(59,130,246,.7);box-shadow:0 0 0 4px rgba(59,130,246,.12)}
          .field-with-icon{position:relative}
          .field-with-icon i{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:rgba(15,23,42,.45)}
          .field-with-icon .field-input{padding-left:38px}
          .field-error{margin-top:6px;color:#ef4444;font-size:.88rem}
          .service-preview{background:#fff;border:1px solid rgba(15,23,42,.08);border-radius:14px;min-height:160px;display:flex;align-items:center;justify-content:center;padding:14px}
          .service-preview__placeholder{color:rgba(15,23,42,.5);text-align:center}
          .service-preview__placeholder i{font-size:2rem;color:rgba(59,130,246,.65)}
          .service-preview__card{display:grid;grid-template-columns:120px 1fr;gap:14px;width:100%}
          .service-preview__img{width:120px;height:90px;border-radius:12px;object-fit:cover;background:#e2e8f0}
          .service-preview__title{margin:0;color:var(--text-dark);font-size:1.05rem}
          .service-preview__meta{margin-top:6px;color:var(--text-light);display:flex;flex-wrap:wrap;gap:10px;font-size:.9rem}
          .service-preview__desc{margin-top:10px;color:rgba(15,23,42,.75);font-size:.95rem;line-height:1.35}
          .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
          .toggle-row{display:flex;gap:12px;align-items:flex-start;margin-top:12px;padding:12px;border-radius:12px;background:#fff;border:1px dashed rgba(15,23,42,.16)}
          .toggle-row input{margin-top:2px}
          .toggle-row strong{display:block;color:var(--text-dark)}
          .toggle-row small{display:block;color:var(--text-light);margin-top:2px}
          .modal-footer{display:flex;justify-content:flex-end;gap:10px;padding:14px 20px;border-top:1px solid rgba(15,23,42,.08);background:rgba(248,250,252,.7)}
          .btn.btn-outline{background:transparent;border:1px solid rgba(15,23,42,.18);color:var(--text-dark)}
          .btn.btn-outline:hover{background:rgba(15,23,42,.05)}
          @media (max-width: 880px){.modal-grid{grid-template-columns:1fr}.service-preview__card{grid-template-columns:1fr}.service-preview__img{width:100%;height:160px}}
        `;
        document.head.appendChild(style);
      })();

      function ensureToastContainer() {
        let container = document.getElementById("toast-container");
        if (container) return container;

        container = document.createElement("div");
        container.id = "toast-container";
        container.style.position = "fixed";
        container.style.top = "20px";
        container.style.right = "20px";
        container.style.zIndex = "9999";
        container.style.display = "flex";
        container.style.flexDirection = "column";
        container.style.gap = "10px";
        document.body.appendChild(container);
        return container;
      }

      function showToast(message, type = "info") {
        const container = ensureToastContainer();
        const toast = document.createElement("div");
        const bg =
          type === "success"
            ? "#10b981"
            : type === "error"
              ? "#ef4444"
              : "#3b82f6";

        toast.textContent = message;
        toast.style.background = bg;
        toast.style.color = "#fff";
        toast.style.padding = "12px 14px";
        toast.style.borderRadius = "12px";
        toast.style.boxShadow = "0 10px 30px rgba(0,0,0,0.12)";
        toast.style.fontSize = "0.95rem";
        toast.style.maxWidth = "320px";
        toast.style.opacity = "0";
        toast.style.transform = "translateY(-6px)";
        toast.style.transition = "opacity 180ms ease, transform 180ms ease";

        container.appendChild(toast);
        requestAnimationFrame(() => {
          toast.style.opacity = "1";
          toast.style.transform = "translateY(0)";
        });

        setTimeout(() => {
          toast.style.opacity = "0";
          toast.style.transform = "translateY(-6px)";
          setTimeout(() => toast.remove(), 220);
        }, 2600);
      }

      function formatPrice(price, priceType) {
        const numeric = Number(price || 0);
        const formatted = isFinite(numeric) ? numeric.toFixed(2) : "0.00";

        switch (priceType) {
          case "hourly":
            return `$${formatted}/hr`;
          case "per_item":
            return `$${formatted}/item`;
          case "custom":
            return `From $${formatted}`;
          case "fixed":
          default:
            return `$${formatted}`;
        }
      }

      function escapeHtml(value) {
        return String(value ?? "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      let _serviceCatalog = [];
      let _serviceIdSet = new Set();
      let _providerServicesById = new Map();
      let _editProviderServiceId = null;
      let _deleteProviderServiceId = null;

      function getApiLang() {
        try {
          if (window.I18n && typeof window.I18n.getLanguage === "function") {
            return String(window.I18n.getLanguage() || "en").toLowerCase();
          }
        } catch (e) {
          // ignore
        }
        return String(
          document.documentElement.getAttribute("lang") || "en",
        ).toLowerCase();
      }

      function initAddServiceModalUX() {
        const overlay = document.getElementById("add-service-modal");
        const card = overlay.querySelector(".modal-card");

        overlay.addEventListener("click", () => closeAddServiceModal());
        card.addEventListener("click", (e) => e.stopPropagation());

        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape" && overlay.style.display !== "none") {
            closeAddServiceModal();
          }
        });
      }

      function initGenericModalUX(modalId, closeFnName) {
        const overlay = document.getElementById(modalId);
        const card = overlay.querySelector(".modal-card");
        overlay.addEventListener("click", () => window[closeFnName]());
        card.addEventListener("click", (e) => e.stopPropagation());
      }

      function openAddServiceModal() {
        const modal = document.getElementById("add-service-modal");
        modal.style.display = "flex";
        document.body.style.overflow = "hidden";
        resetAddServiceForm();
        bootstrapAddService();
      }

      function closeAddServiceModal() {
        const modal = document.getElementById("add-service-modal");
        modal.style.display = "none";
        document.body.style.overflow = "";
      }

      function resetAddServiceForm() {
        document.getElementById("add-search").value = "";
        document.getElementById("add-price").value = "";
        document.getElementById("add-description").value = "";
        document.getElementById("add-is-active").checked = true;
        resetAddServiceImages();
        hideFieldError("add-service-error");
        hideFieldError("add-price-error");
        const preview = document.getElementById("service-preview");
        preview.innerHTML = `
          <div class="service-preview__placeholder">
            <i class="fas fa-layer-group"></i>
            <p>Select a service to see details</p>
          </div>
        `;
      }

      function setSubmitting(isSubmitting) {
        const btn = document.getElementById("add-service-submit");
        btn.disabled = isSubmitting;
        btn.querySelector(".btn-label").style.display = isSubmitting
          ? "none"
          : "inline";
        btn.querySelector(".btn-spinner").style.display = isSubmitting
          ? "inline"
          : "none";
      }

      function setSubmittingFor(buttonId, isSubmitting) {
        const btn = document.getElementById(buttonId);
        btn.disabled = isSubmitting;
        btn.querySelector(".btn-label").style.display = isSubmitting
          ? "none"
          : "inline";
        btn.querySelector(".btn-spinner").style.display = isSubmitting
          ? "inline"
          : "none";
      }

      function showFieldError(id, message) {
        const el = document.getElementById(id);
        el.textContent = message;
        el.style.display = "block";
      }

      function hideFieldError(id) {
        const el = document.getElementById(id);
        el.textContent = "";
        el.style.display = "none";
      }

      async function bootstrapAddService() {
        try {
          await loadCategoriesForAddModal();
          await loadServicesForAddModal();

          document.getElementById("add-category").onchange = () =>
            loadServicesForAddModal();

          const search = document.getElementById("add-search");
          let timer;
          search.oninput = () => {
            clearTimeout(timer);
            timer = setTimeout(() => loadServicesForAddModal(), 250);
          };

          document.getElementById("add-service-select").onchange =
            onSelectCatalogService;

          // Images
          const imgInput = document.getElementById("add-images");
          imgInput.onchange = onAddServiceImagesSelected;
        } catch (e) {
          console.error(e);
          showToast("Failed to load service catalog", "error");
        }
      }

      let _addServiceImages = [];

      let _editExistingImages = [];
      let _editNewImages = [];

      function resetAddServiceImages() {
        _addServiceImages = [];
        const input = document.getElementById("add-images");
        if (input) input.value = "";
        renderAddServiceImagesPreview();
      }

      function resetEditServiceImages() {
        // Revoke object URLs for new images
        for (const item of _editNewImages) {
          if (item && item.previewUrl) {
            try {
              URL.revokeObjectURL(item.previewUrl);
            } catch (e) {
              // ignore
            }
          }
        }
        _editExistingImages = [];
        _editNewImages = [];
        const input = document.getElementById("edit-images");
        if (input) input.value = "";
        renderEditServiceImagesPreview();
      }

      function onAddServiceImagesSelected(e) {
        const files = Array.from(e.target.files || []);
        const max = 5;
        _addServiceImages = files.slice(0, max).map((file) => ({
          file,
          previewUrl: URL.createObjectURL(file),
          uploaded: null,
        }));
        renderAddServiceImagesPreview();
      }

      function removeAddServiceImage(index) {
        const item = _addServiceImages[index];
        if (item && item.previewUrl) {
          try {
            URL.revokeObjectURL(item.previewUrl);
          } catch (e) {
            // ignore
          }
        }
        _addServiceImages.splice(index, 1);
        renderAddServiceImagesPreview();
      }

      function renderAddServiceImagesPreview() {
        const el = document.getElementById("add-images-preview");
        if (!el) return;
        if (!_addServiceImages.length) {
          el.innerHTML = "";
          return;
        }

        el.innerHTML = _addServiceImages
          .map((img, idx) => {
            const status = img.uploaded
              ? "Uploaded"
              : img.uploading
                ? "Uploading..."
                : "Ready";
            return `
              <div style="position:relative; width:92px; height:92px; border-radius:12px; overflow:hidden; border:1px solid rgba(15,23,42,.12); background:#fff;">
                <img src="${img.previewUrl}" alt="Image" style="width:100%; height:100%; object-fit:cover; display:block;" />
                <button type="button" onclick="removeAddServiceImage(${idx})" aria-label="Remove" style="position:absolute; top:6px; right:6px; width:26px; height:26px; border:none; border-radius:8px; background:rgba(15,23,42,.65); color:#fff; cursor:pointer;">&times;</button>
                <div style="position:absolute; left:0; right:0; bottom:0; padding:4px 6px; font-size:11px; color:#fff; background:rgba(15,23,42,.55); text-align:center;">${status}</div>
              </div>
            `;
          })
          .join("");
      }

      function onEditServiceImagesSelected(e) {
        const files = Array.from(e.target.files || []);

        const existingCount = Array.isArray(_editExistingImages)
          ? _editExistingImages.filter((x) => x && x.keep).length
          : 0;
        const maxTotal = 10;
        const remaining = Math.max(0, maxTotal - existingCount);

        _editNewImages = files.slice(0, remaining).map((file) => ({
          file,
          previewUrl: URL.createObjectURL(file),
          uploaded: null,
          uploading: false,
        }));
        renderEditServiceImagesPreview();
      }

      function removeEditExistingImage(index) {
        const item = _editExistingImages[index];
        if (!item) return;
        item.keep = false;
        renderEditServiceImagesPreview();
      }

      function removeEditNewImage(index) {
        const item = _editNewImages[index];
        if (item && item.previewUrl) {
          try {
            URL.revokeObjectURL(item.previewUrl);
          } catch (e) {
            // ignore
          }
        }
        _editNewImages.splice(index, 1);
        renderEditServiceImagesPreview();
      }

      function renderEditServiceImagesPreview() {
        const el = document.getElementById("edit-images-preview");
        if (!el) return;

        const existing = Array.isArray(_editExistingImages)
          ? _editExistingImages
              .map((img, idx) => ({ img, idx }))
              .filter(({ img }) => img && img.keep)
          : [];
        const adding = Array.isArray(_editNewImages) ? _editNewImages : [];

        if (!existing.length && !adding.length) {
          el.innerHTML = "";
          return;
        }

        const existingHtml = existing
          .map(({ img, idx }) => {
            const url = img.url;
            return `
              <div style="position:relative; width:92px; height:92px; border-radius:12px; overflow:hidden; border:1px solid rgba(15,23,42,.12); background:#fff;">
                <img src="${escapeHtml(url)}" alt="Image" style="width:100%; height:100%; object-fit:cover; display:block;" />
                <button type="button" onclick="removeEditExistingImage(${idx})" aria-label="Remove" style="position:absolute; top:6px; right:6px; width:26px; height:26px; border:none; border-radius:8px; background:rgba(15,23,42,.65); color:#fff; cursor:pointer;">&times;</button>
                <div style="position:absolute; left:0; right:0; bottom:0; padding:4px 6px; font-size:11px; color:#fff; background:rgba(15,23,42,.55); text-align:center;">Existing</div>
              </div>
            `;
          })
          .join("");

        const newHtml = adding
          .map((img, idx) => {
            const status = img.uploaded
              ? "Uploaded"
              : img.uploading
                ? "Uploading..."
                : "Ready";
            return `
              <div style="position:relative; width:92px; height:92px; border-radius:12px; overflow:hidden; border:1px solid rgba(15,23,42,.12); background:#fff;">
                <img src="${img.previewUrl}" alt="Image" style="width:100%; height:100%; object-fit:cover; display:block;" />
                <button type="button" onclick="removeEditNewImage(${idx})" aria-label="Remove" style="position:absolute; top:6px; right:6px; width:26px; height:26px; border:none; border-radius:8px; background:rgba(15,23,42,.65); color:#fff; cursor:pointer;">&times;</button>
                <div style="position:absolute; left:0; right:0; bottom:0; padding:4px 6px; font-size:11px; color:#fff; background:rgba(15,23,42,.55); text-align:center;">${status}</div>
              </div>
            `;
          })
          .join("");

        el.innerHTML = existingHtml + newHtml;
      }

      async function getCloudinarySignature(folder) {
        const token = Auth.getToken();
        const url = new URL(
          `${Auth.apiUrl}/uploads/cloudinary-signature`,
          window.location.origin,
        );
        if (folder) url.searchParams.set("folder", folder);
        const res = await fetch(url.toString(), {
          headers: { Authorization: `Bearer ${token}` },
          cache: "no-store",
        });
        const json = await res.json();
        if (!res.ok || !json.success) {
          throw new Error(json?.message || "Failed to get upload signature");
        }
        return json.data;
      }

      async function uploadToCloudinary(file, signatureData) {
        const cloudName = signatureData.cloud_name;
        const form = new FormData();
        form.append("file", file);
        form.append("api_key", signatureData.api_key);
        form.append("timestamp", String(signatureData.timestamp));
        form.append("signature", signatureData.signature);
        if (signatureData.folder) form.append("folder", signatureData.folder);

        const uploadUrl = `https://api.cloudinary.com/v1_1/${encodeURIComponent(cloudName)}/image/upload`;
        const res = await fetch(uploadUrl, { method: "POST", body: form });
        const json = await res.json().catch(() => null);
        if (!res.ok || !json) {
          throw new Error("Image upload failed");
        }
        return {
          url: json.secure_url || json.url,
          public_id: json.public_id,
        };
      }

      async function loadCategoriesForAddModal() {
        const select = document.getElementById("add-category");
        select.innerHTML = `<option value="">All categories</option>`;

        const res = await fetch(
          `${Auth.apiUrl}/categories?lang=${encodeURIComponent(getApiLang())}`,
        );
        const json = await res.json();
        if (!res.ok || !json.success) return;

        json.data.forEach((cat) => {
          const opt = document.createElement("option");
          opt.value = cat.category_id;
          opt.textContent = cat.category_name;
          select.appendChild(opt);
        });
      }

      async function loadServicesForAddModal() {
        const categoryId = document.getElementById("add-category").value;
        const search = document.getElementById("add-search").value.trim();

        const params = new URLSearchParams();
        params.set("limit", "100");
        params.set("lang", getApiLang());
        if (categoryId) params.set("category_id", categoryId);
        if (search) params.set("search", search);

        const res = await fetch(`${Auth.apiUrl}/services?${params.toString()}`);
        const json = await res.json();
        if (!res.ok || !json.success) {
          showToast(json.message || "Failed to load services", "error");
          return;
        }

        _serviceCatalog = Array.isArray(json.data) ? json.data : [];

        const select = document.getElementById("add-service-select");
        select.innerHTML = "";

        // Filter out services already offered
        const filtered = _serviceCatalog.filter(
          (s) => !_serviceIdSet.has(Number(s.service_id)),
        );

        if (filtered.length === 0) {
          const opt = document.createElement("option");
          opt.disabled = true;
          opt.textContent = "No available services found";
          select.appendChild(opt);
          return;
        }

        filtered.forEach((svc) => {
          const opt = document.createElement("option");
          opt.value = svc.service_id;
          const cat = svc.category_name ? `  ${svc.category_name}` : "";
          opt.textContent = `${svc.service_name}${cat}`;
          select.appendChild(opt);
        });
      }

      function onSelectCatalogService() {
        hideFieldError("add-service-error");
        const select = document.getElementById("add-service-select");
        const serviceId = Number(select.value);
        const svc = _serviceCatalog.find(
          (s) => Number(s.service_id) === serviceId,
        );
        if (!svc) return;

        // Pre-fill from base service
        const price = document.getElementById("add-price");
        if (!price.value) price.value = Number(svc.base_price || 0).toFixed(2);
        document.getElementById("add-price-type").value =
          svc.price_type || "fixed";

        const preview = document.getElementById("service-preview");
        const img = normalizeImageUrl(svc.service_image);
        const cat = escapeHtml(svc.category_name || "Service");
        const name = escapeHtml(svc.service_name || "Service");
        const desc = escapeHtml(svc.description || "");
        const duration = Number(svc.duration_minutes || 0);
        const durationLabel = duration > 0 ? `${duration} min` : "Flexible";
        const basePrice = formatPrice(svc.base_price, svc.price_type);

        preview.innerHTML = `
          <div class="service-preview__card">
            <img class="service-preview__img" src="${img}" alt="${name}" onerror="this.src='../assets/images/services/cleaning1.jpg'" />
            <div>
              <h3 class="service-preview__title">${name}</h3>
              <div class="service-preview__meta">
                <span><i class="fas fa-tag"></i> ${cat}</span>
                <span><i class="far fa-clock"></i> ${durationLabel}</span>
                <span><i class="fas fa-coins"></i> Base: ${basePrice}</span>
              </div>
              <div class="service-preview__desc">${desc}</div>
            </div>
          </div>
        `;
      }

      async function submitAddService() {
        hideFieldError("add-service-error");
        hideFieldError("add-price-error");

        const serviceId = Number(
          document.getElementById("add-service-select").value,
        );
        const priceRaw = document.getElementById("add-price").value;
        const price = Number(priceRaw);
        const priceType = document.getElementById("add-price-type").value;
        const description = document
          .getElementById("add-description")
          .value.trim();
        const isActive = document.getElementById("add-is-active").checked;

        if (!serviceId) {
          showFieldError("add-service-error", "Please select a service.");
          return;
        }
        if (!isFinite(price) || price < 0) {
          showFieldError(
            "add-price-error",
            "Please enter a valid price (0 or more).",
          );
          return;
        }

        setSubmitting(true);
        try {
          // Upload images first (if any)
          const uploadedImages = [];
          if (_addServiceImages.length > 0) {
            const sig = await getCloudinarySignature(
              "moueene/provider-services",
            );
            for (const item of _addServiceImages) {
              item.uploading = true;
              renderAddServiceImagesPreview();
              const uploaded = await uploadToCloudinary(item.file, sig);
              item.uploading = false;
              item.uploaded = uploaded;
              renderAddServiceImagesPreview();
              if (uploaded && uploaded.url) {
                uploadedImages.push(uploaded);
              }
            }
          }

          const token = Auth.getToken();
          const res = await fetch(`${Auth.apiUrl}/providers/services`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              service_id: serviceId,
              price: price,
              price_type: priceType,
              description: description || null,
              is_active: isActive,
              images: uploadedImages,
            }),
          });

          const json = await res.json();
          if (!res.ok || !json.success) {
            const msg =
              json && json.message ? json.message : "Failed to add service";
            showToast(msg, "error");
            return;
          }

          showToast("Service added successfully", "success");
          closeAddServiceModal();
          await loadProviderServices();
        } catch (e) {
          console.error(e);
          showToast("Failed to add service", "error");
        } finally {
          setSubmitting(false);
        }
      }

      function normalizeImageUrl(url) {
        if (!url) return "../assets/images/services/cleaning1.jpg";
        if (url.startsWith("http://") || url.startsWith("https://")) return url;
        if (url.startsWith("/")) return url;
        return `../${url}`;
      }

      function renderEmptyServices(container) {
        container.innerHTML = `
          <div class="empty-state" style="text-align:center; padding: 60px 30px; color: var(--text-light); background: rgba(255,255,255,0.7); border-radius: 16px;">
            <i class="fas fa-briefcase" style="font-size: 3rem; color: var(--primary-color);"></i>
            <h3 style="margin-top: 15px; color: var(--text-dark);">No services yet</h3>
            <p style="margin-top: 8px;">You haven't added any services. Click Add New Service to get started.</p>
          </div>
        `;
      }

      function renderServices(container, services) {
        _providerServicesById = new Map(
          services.map((s) => [Number(s.provider_service_id), s]),
        );

        container.innerHTML = services
          .map((svc) => {
            const title = escapeHtml(svc.service_name || "Service");
            const description = escapeHtml(svc.description || "");
            const category = escapeHtml(svc.category_name || "Service");
            const duration = Number(svc.duration_minutes || 0);
            const durationLabel = duration > 0 ? `${duration} min` : "Flexible";
            const active = svc.is_active === 1 || svc.is_active === true;
            const statusClass = active ? "status-active" : "";
            const statusText = active ? "Active" : "Inactive";
            const providerImage =
              Array.isArray(svc.images) && svc.images.length > 0
                ? svc.images[0]?.url
                : null;
            const image = normalizeImageUrl(providerImage || svc.service_image);
            const priceLabel = formatPrice(svc.price, svc.price_type);
            const providerServiceId = Number(svc.provider_service_id);

            return `
              <div class="service-card">
                <img src="${image}" alt="${title}" class="service-image" onerror="this.src='../assets/images/services/cleaning1.jpg'" />
                <div class="service-details">
                  <div class="service-header">
                    <h3 class="service-title">${title}</h3>
                    <span class="service-price">${priceLabel}</span>
                  </div>
                  <p class="service-desc">${description}</p>
                  <div class="service-meta">
                    <span><i class="fas fa-tag"></i> ${category}</span>
                    <span><i class="far fa-clock"></i> ${durationLabel}</span>
                  </div>
                </div>
                <div class="service-actions">
                  <div class="status-toggle ${statusClass}" role="button" tabindex="0" onclick="toggleServiceStatus(${providerServiceId})">
                    <span class="status-indicator"></span> ${statusText}
                  </div>
                  <div class="action-buttons">
                    <button class="btn-icon btn-edit" title="Edit" onclick="openEditServiceModal(${providerServiceId})">
                      <i class="fas fa-pen"></i>
                    </button>
                    <button class="btn-icon btn-delete" title="Delete" onclick="openDeleteServiceModal(${providerServiceId})">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </div>
              </div>
            `;
          })
          .join("");
      }

      function openEditServiceModal(providerServiceId) {
        const svc = _providerServicesById.get(Number(providerServiceId));
        if (!svc) {
          showToast("Service not found", "error");
          return;
        }

        _editProviderServiceId = Number(providerServiceId);
        hideFieldError("edit-price-error");

        document.getElementById("edit-price").value = Number(
          svc.price || 0,
        ).toFixed(2);
        document.getElementById("edit-price-type").value =
          svc.price_type || "fixed";
        document.getElementById("edit-description").value =
          svc.description || "";
        document.getElementById("edit-is-active").checked =
          svc.is_active === 1 || svc.is_active === true;

        // Images
        resetEditServiceImages();
        const existing = Array.isArray(svc.images) ? svc.images : [];
        _editExistingImages = existing
          .filter((x) => x && x.url)
          .slice(0, 10)
          .map((x) => ({
            url: x.url,
            public_id: x.public_id || null,
            keep: true,
          }));
        renderEditServiceImagesPreview();

        const preview = document.getElementById("edit-service-preview");
        const providerImage =
          Array.isArray(svc.images) && svc.images.length > 0
            ? svc.images[0]?.url
            : null;
        const img = normalizeImageUrl(providerImage || svc.service_image);
        const cat = escapeHtml(svc.category_name || "Service");
        const name = escapeHtml(svc.service_name || "Service");
        const desc = escapeHtml(svc.description || "");
        const duration = Number(svc.duration_minutes || 0);
        const durationLabel = duration > 0 ? `${duration} min` : "Flexible";

        preview.innerHTML = `
          <div class="service-preview__card">
            <img class="service-preview__img" src="${img}" alt="${name}" onerror="this.src='../assets/images/services/cleaning1.jpg'" />
            <div>
              <h3 class="service-preview__title">${name}</h3>
              <div class="service-preview__meta">
                <span><i class="fas fa-tag"></i> ${cat}</span>
                <span><i class="far fa-clock"></i> ${durationLabel}</span>
              </div>
              <div class="service-preview__desc">${desc}</div>
            </div>
          </div>
        `;

        const modal = document.getElementById("edit-service-modal");
        modal.style.display = "flex";
        document.body.style.overflow = "hidden";
      }

      function closeEditServiceModal() {
        const modal = document.getElementById("edit-service-modal");
        modal.style.display = "none";
        document.body.style.overflow = "";
        _editProviderServiceId = null;
        resetEditServiceImages();
      }

      async function submitEditService() {
        hideFieldError("edit-price-error");
        const providerServiceId = _editProviderServiceId;
        if (!providerServiceId) return;

        const priceRaw = document.getElementById("edit-price").value;
        const price = Number(priceRaw);
        const priceType = document.getElementById("edit-price-type").value;
        const description = document
          .getElementById("edit-description")
          .value.trim();
        const isActive = document.getElementById("edit-is-active").checked;

        if (!isFinite(price) || price < 0) {
          showFieldError(
            "edit-price-error",
            "Please enter a valid price (0 or more).",
          );
          return;
        }

        setSubmittingFor("edit-service-submit", true);
        try {
          // Upload any newly selected images first
          const uploadedImages = [];
          if (Array.isArray(_editNewImages) && _editNewImages.length > 0) {
            const sig = await getCloudinarySignature("moueene/provider-services");
            for (const item of _editNewImages) {
              item.uploading = true;
              renderEditServiceImagesPreview();
              const uploaded = await uploadToCloudinary(item.file, sig);
              item.uploading = false;
              item.uploaded = uploaded;
              renderEditServiceImagesPreview();
              if (uploaded && uploaded.url) {
                uploadedImages.push(uploaded);
              }
            }
          }

          const keptExisting = Array.isArray(_editExistingImages)
            ? _editExistingImages
                .filter((x) => x && x.keep && x.url)
                .map((x) => ({ url: x.url, public_id: x.public_id || null }))
            : [];
          const finalImages = [...keptExisting, ...uploadedImages].slice(0, 10);

          const token = Auth.getToken();
          const res = await fetch(
            `${Auth.apiUrl}/providers/services/${providerServiceId}`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({
                price,
                price_type: priceType,
                description: description || null,
                is_active: isActive,
                images: finalImages,
              }),
            },
          );
          const json = await res.json();

          if (!res.ok || !json.success) {
            showToast(json.message || "Failed to update service", "error");
            return;
          }

          showToast("Service updated", "success");
          closeEditServiceModal();
          await loadProviderServices();
        } catch (e) {
          console.error(e);
          showToast("Failed to update service", "error");
        } finally {
          setSubmittingFor("edit-service-submit", false);
        }
      }

      function openDeleteServiceModal(providerServiceId) {
        const svc = _providerServicesById.get(Number(providerServiceId));
        if (!svc) {
          showToast("Service not found", "error");
          return;
        }
        _deleteProviderServiceId = Number(providerServiceId);

        const name = escapeHtml(svc.service_name || "this service");
        document.getElementById("delete-service-message").innerHTML =
          `Are you sure you want to delete <strong>${name}</strong>?`;

        const modal = document.getElementById("delete-service-modal");
        modal.style.display = "flex";
        document.body.style.overflow = "hidden";
      }

      function closeDeleteServiceModal() {
        const modal = document.getElementById("delete-service-modal");
        modal.style.display = "none";
        document.body.style.overflow = "";
        _deleteProviderServiceId = null;
      }

      async function confirmDeleteService() {
        const providerServiceId = _deleteProviderServiceId;
        if (!providerServiceId) return;

        setSubmittingFor("delete-service-submit", true);
        try {
          const token = Auth.getToken();
          const res = await fetch(
            `${Auth.apiUrl}/providers/services/${providerServiceId}`,
            {
              method: "DELETE",
              headers: {
                Authorization: `Bearer ${token}`,
              },
            },
          );
          const json = await res.json();
          if (!res.ok || !json.success) {
            showToast(json.message || "Failed to delete service", "error");
            return;
          }

          showToast("Service deleted", "success");
          closeDeleteServiceModal();
          await loadProviderServices();
        } catch (e) {
          console.error(e);
          showToast("Failed to delete service", "error");
        } finally {
          setSubmittingFor("delete-service-submit", false);
        }
      }

      async function toggleServiceStatus(providerServiceId) {
        const svc = _providerServicesById.get(Number(providerServiceId));
        if (!svc) return;
        const next = !(svc.is_active === 1 || svc.is_active === true);

        try {
          const token = Auth.getToken();
          const res = await fetch(
            `${Auth.apiUrl}/providers/services/${providerServiceId}`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({ is_active: next }),
            },
          );
          const json = await res.json();
          if (!res.ok || !json.success) {
            showToast(json.message || "Failed to update status", "error");
            return;
          }
          await loadProviderServices();
        } catch (e) {
          console.error(e);
          showToast("Failed to update status", "error");
        }
      }

      async function loadProviderServices() {
        const container = document.getElementById("services-list");
        try {
          const token = Auth.getToken();
          const response = await fetch(`${Auth.apiUrl}/providers/services`, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          const result = await response.json();

          if (!response.ok || !result.success) {
            container.innerHTML = `
              <div class="empty-state" style="text-align:center; padding: 60px 30px; color: var(--text-light); background: rgba(255,255,255,0.7); border-radius: 16px;">
                <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #f59e0b;"></i>
                <h3 style="margin-top: 15px; color: var(--text-dark);">Couldn't load services</h3>
                <p style="margin-top: 8px;">${result.message || "Please try again later."}</p>
              </div>
            `;
            return;
          }

          const services = Array.isArray(result.data) ? result.data : [];
          _serviceIdSet = new Set(
            services
              .map((s) => Number(s.service_id))
              .filter((n) => Number.isFinite(n)),
          );
          if (services.length === 0) {
            renderEmptyServices(container);
            return;
          }

          renderServices(container, services);
        } catch (error) {
          console.error("Error loading provider services:", error);
          container.innerHTML = `
            <div class="empty-state" style="text-align:center; padding: 60px 30px; color: var(--text-light); background: rgba(255,255,255,0.7); border-radius: 16px;">
              <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #ef4444;"></i>
              <h3 style="margin-top: 15px; color: var(--text-dark);">Failed to load services</h3>
              <p style="margin-top: 8px;">Please refresh the page.</p>
            </div>
          `;
        }
      }

      // Page specific logic
      document.addEventListener("DOMContentLoaded", async () => {
        if (!Auth.isAuthenticated()) {
          window.location.href = "login.html";
          return;
        }

        if (Auth.getUserType && Auth.getUserType() !== "provider") {
          window.location.href = "login.html";
          return;
        }

        initAddServiceModalUX();
        initGenericModalUX("edit-service-modal", "closeEditServiceModal");
        initGenericModalUX("delete-service-modal", "closeDeleteServiceModal");

        // Edit images input
        const editImgInput = document.getElementById("edit-images");
        if (editImgInput) editImgInput.onchange = onEditServiceImagesSelected;

        if (window.ProviderUI) {
          await ProviderUI.loadAndApply();
        }

        // User menu dropdown
        const userMenu = document.getElementById("user-menu");
        userMenu
          .querySelector(".user-menu-trigger")
          .addEventListener("click", (e) => {
            e.stopPropagation();
            userMenu.classList.toggle("active");
          });
        document.addEventListener("click", () => {
          userMenu.classList.remove("active");
        });

        // Logout handlers
        document.getElementById("logout-btn").addEventListener("click", (e) => {
          e.preventDefault();
          Auth.logout();
        });
        document
          .getElementById("header-logout-btn")
          .addEventListener("click", (e) => {
            e.preventDefault();
            Auth.logout();
          });

        await loadProviderServices();
      });
    </script>
  </body>
</html>
