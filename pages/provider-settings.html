<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profile Settings - Provider Dashboard</title>
    <link rel="icon" type="image/webp" href="/assets/images/logo.webp" />
    <link rel="stylesheet" href="../assets/css/style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Dashboard Header Styles */
      .dashboard-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: white;
        border-bottom: 1px solid #e5e7eb;
        z-index: 100;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }

      .dashboard-header .container {
        max-width: 100%;
        padding: 0 30px;
      }

      .dashboard-navbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        height: 70px;
        gap: 30px;
      }

      .dashboard-logo {
        display: flex;
        align-items: center;
        gap: 12px;
        text-decoration: none;
        font-weight: 700;
        font-size: 1.3rem;
        color: var(--text-dark);
      }

      .dashboard-logo img {
        height: 38px;
        width: auto;
      }

      .dashboard-search {
        flex: 1;
        max-width: 500px;
        position: relative;
      }

      .dashboard-search input {
        width: 100%;
        padding: 10px 20px 10px 45px;
        border: 1px solid #e5e7eb;
        border-radius: 25px;
        background: #f9fafb;
        outline: none;
        transition: all 0.3s;
        font-size: 0.95rem;
      }

      .dashboard-search input:focus {
        background: white;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(0, 201, 167, 0.1);
      }

      .dashboard-search i {
        position: absolute;
        left: 18px;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
        font-size: 0.9rem;
      }

      .dashboard-actions {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .dashboard-icon-btn {
        position: relative;
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: #f9fafb;
        border: none;
        display: grid;
        place-items: center;
        cursor: pointer;
        transition: all 0.2s;
        color: #6b7280;
      }

      .dashboard-icon-btn:hover {
        background: #f3f4f6;
        color: var(--primary-color);
      }

      .dashboard-icon-btn .badge-dot {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 8px;
        height: 8px;
        background: #ef4444;
        border-radius: 50%;
        border: 2px solid white;
      }

      .user-menu {
        position: relative;
      }

      .user-menu-trigger {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 6px 12px 6px 6px;
        border-radius: 25px;
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        cursor: pointer;
        transition: all 0.2s;
      }

      .user-menu-trigger:hover {
        background: #f3f4f6;
        border-color: #d1d5db;
      }

      .user-menu-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .user-menu-info {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
      }

      .user-menu-name {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-dark);
        line-height: 1.2;
      }

      .user-menu-role {
        font-size: 0.75rem;
        color: #6b7280;
      }

      .user-menu-chevron {
        color: #9ca3af;
        font-size: 0.75rem;
      }

      .user-dropdown {
        position: absolute;
        top: calc(100% + 10px);
        right: 0;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        min-width: 220px;
        padding: 8px 0;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.3s;
        z-index: 1000;
      }

      .user-menu.active .user-dropdown {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .user-dropdown-header {
        padding: 12px 16px;
        border-bottom: 1px solid #f3f4f6;
        margin-bottom: 8px;
      }

      .user-dropdown-name {
        font-weight: 600;
        font-size: 0.95rem;
        color: var(--text-dark);
        margin-bottom: 2px;
      }

      .user-dropdown-email {
        font-size: 0.8rem;
        color: #6b7280;
      }

      .user-dropdown a {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 16px;
        color: #4b5563;
        text-decoration: none;
        transition: all 0.2s;
      }

      .user-dropdown a:hover {
        background: #f9fafb;
        color: var(--primary-color);
      }

      .user-dropdown a i {
        width: 18px;
        text-align: center;
        font-size: 0.9rem;
      }

      .user-dropdown-divider {
        height: 1px;
        background: #f3f4f6;
        margin: 8px 0;
      }

      .user-dropdown a.logout {
        color: #ef4444;
      }

      .user-dropdown a.logout:hover {
        background: #fef2f2;
      }

      @media (max-width: 768px) {
        .dashboard-search {
          display: none;
        }

        .user-menu-info {
          display: none;
        }

        .dashboard-header .container {
          padding: 0 20px;
        }
      }

      .provider-dashboard {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
        padding-top: 80px;
      }
      .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 30px 20px;
      }
      .dashboard-layout {
        display: grid;
        grid-template-columns: 280px 1fr;
        gap: 30px;
      }
      @media (max-width: 992px) {
        .dashboard-layout {
          grid-template-columns: 1fr;
        }
        .provider-sidebar {
          display: none;
        }
      }
      .provider-sidebar {
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
        height: fit-content;
        position: sticky;
        top: 100px;
      }
      .provider-profile-card {
        padding: 30px 20px;
        text-align: center;
        border-bottom: 1px solid var(--border-color);
      }
      .provider-avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        margin: 0 auto 15px;
        border: 4px solid var(--primary-color);
        object-fit: cover;
      }
      .provider-profile-card h3 {
        margin: 0 0 5px;
        font-size: 1.2rem;
        color: var(--text-dark);
      }
      .provider-profile-card .badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-top: 8px;
      }
      .badge-verified {
        background: linear-gradient(135deg, #22c55e, #16a34a);
        color: white;
      }
      .badge-pending {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
      }
      .sidebar-nav {
        padding: 15px 0;
      }
      .sidebar-nav a {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 25px;
        color: var(--text-light);
        transition: all 0.3s ease;
        font-weight: 500;
        border-left: 3px solid transparent;
        text-decoration: none;
      }
      .sidebar-nav a:hover,
      .sidebar-nav a.active {
        background: rgba(0, 201, 167, 0.08);
        color: var(--primary-color);
        border-left-color: var(--primary-color);
      }
      .sidebar-nav a i {
        width: 20px;
        text-align: center;
      }

      /* Settings Specific Styles */
      .settings-card {
        background: white;
        padding: 30px;
        border-radius: 16px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        margin-bottom: 30px;
      }
      .settings-card h2 {
        margin-top: 0;
        margin-bottom: 25px;
        font-size: 1.4rem;
        color: var(--text-dark);
        border-bottom: 1px solid #f0f0f0;
        padding-bottom: 15px;
      }
      .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }
      @media (max-width: 768px) {
        .form-grid {
          grid-template-columns: 1fr;
        }
      }
      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--text-dark);
      }
      .form-control {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-family: inherit;
        transition: border 0.3s;
      }
      .form-control:focus {
        outline: none;
        border-color: var(--primary-color);
      }
      textarea.form-control {
        resize: vertical;
        min-height: 100px;
      }
      .btn-save {
        background: var(--primary-color);
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.3s;
      }
      .btn-save:hover {
        background: #00b395;
      }

      .profile-upload {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 20px;
      }
      .current-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header class="dashboard-header">
      <div class="container">
        <nav class="dashboard-navbar">
          <a href="provider-dashboard.html" class="dashboard-logo">
            <img src="../logo.png" alt="Moueene Logo" />
          </a>

          <div class="dashboard-search">
            <i class="fas fa-search"></i>
            <input
              type="text"
              placeholder="Search services, bookings, customers..."
            />
          </div>

          <div class="dashboard-actions">
            <button
              class="dashboard-icon-btn"
              id="notifications-btn"
              title="Notifications"
            >
              <i class="fas fa-bell"></i>
              <span class="badge-dot"></span>
            </button>

            <button class="dashboard-icon-btn" title="Messages">
              <i class="fas fa-envelope"></i>
            </button>

            <div class="user-menu" id="user-menu">
              <div class="user-menu-trigger">
                <img
                  src="https://ui-avatars.com/api/?name=Provider&background=00c9a7&color=fff&size=36"
                  alt="User"
                  class="user-menu-avatar"
                  id="header-avatar"
                />
                <div class="user-menu-info">
                  <div class="user-menu-name" id="header-user-name">
                    Loading...
                  </div>
                  <div class="user-menu-role">Service Provider</div>
                </div>
                <i class="fas fa-chevron-down user-menu-chevron"></i>
              </div>

              <div class="user-dropdown">
                <div class="user-dropdown-header">
                  <div class="user-dropdown-name" id="dropdown-user-name">
                    Loading...
                  </div>
                  <div class="user-dropdown-email" id="dropdown-user-email">
                    email@example.com
                  </div>
                </div>
                <a href="provider-settings.html">
                  <i class="fas fa-user"></i>
                  <span>My Profile</span>
                </a>

                <a href="provider-earnings.html">
                  <i class="fas fa-wallet"></i>
                  <span>Earnings</span>
                </a>
                <div class="user-dropdown-divider"></div>
                <a href="#" class="logout" id="header-logout-btn">
                  <i class="fas fa-sign-out-alt"></i>
                  <span>Logout</span>
                </a>
              </div>
            </div>
          </div>
        </nav>
      </div>
    </header>

    <div class="provider-dashboard">
      <div class="dashboard-container">
        <div class="dashboard-layout">
          <!-- Sidebar -->
          <aside class="provider-sidebar">
            <div class="provider-profile-card">
              <img
                id="provider-avatar"
                src="https://ui-avatars.com/api/?name=Provider&background=00c9a7&color=fff&size=100"
                alt="Provider Avatar"
                class="provider-avatar"
              />
              <h3 id="provider-name">Loading...</h3>
              <p
                style="
                  color: var(--text-light);
                  font-size: 0.85rem;
                  margin: 5px 0;
                "
              >
                Service Provider
              </p>
              <span class="badge badge-pending" id="verification-badge">
                <i class="fas fa-clock"></i> Pending Verification
              </span>
            </div>

            <nav class="sidebar-nav">
              <a href="provider-dashboard.html" class="">
                <i class="fas fa-th-large"></i>
                <span>Dashboard</span>
              </a>
              <a href="provider-services.html" class="">
                <i class="fas fa-briefcase"></i>
                <span>My Services</span>
              </a>
              <a href="provider-bookings.html" class="">
                <i class="fas fa-calendar-alt"></i>
                <span>Bookings</span>
              </a>
              <a href="provider-messages.html" class="">
                <i class="fas fa-envelope"></i>
                <span>Messages</span>
              </a>
              <a href="provider-reviews.html" class="">
                <i class="fas fa-star"></i>
                <span>Reviews</span>
              </a>
              <a href="provider-earnings.html" class="">
                <i class="fas fa-wallet"></i>
                <span>Earnings</span>
              </a>
              <a href="provider-settings.html" class="active">
                <i class="fas fa-user-edit"></i>
                <span>Settings</span>
              </a>
              <a href="#" id="logout-btn">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
              </a>
            </nav>
          </aside>

          <!-- Main Content -->
          <main class="provider-main">
            <div class="settings-card">
              <h2>Profile Information</h2>
              <form id="profile-form">
                <div class="profile-upload">
                  <img
                    src="https://ui-avatars.com/api/?name=Provider&background=00c9a7&color=fff&size=80"
                    alt="Profile"
                    class="current-avatar"
                    id="settings-avatar"
                  />
                  <div>
                    <div
                      style="
                        display: flex;
                        gap: 10px;
                        align-items: center;
                        flex-wrap: wrap;
                      "
                    >
                      <button
                        type="button"
                        class="btn btn-outline"
                        id="change-photo-btn"
                      >
                        Change Photo
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline"
                        id="remove-photo-btn"
                        title="Remove profile photo"
                      >
                        Remove Photo
                      </button>
                    </div>
                    <div
                      style="font-size: 0.8rem; color: #888; margin-top: 5px"
                    >
                      Max file size: 2MB. JPG, PNG.
                    </div>
                    <div
                      id="photo-upload-status"
                      style="font-size: 0.8rem; color: #6b7280; margin-top: 5px"
                    ></div>
                  </div>
                </div>

                <input
                  type="file"
                  id="profile-photo-input"
                  accept="image/*"
                  style="display: none"
                />

                <!-- Cloudinary profile_picture URL (hidden) -->
                <input type="hidden" id="profile-picture-url" value="" />

                <div class="form-grid">
                  <div class="form-group">
                    <label>First Name</label>
                    <input
                      type="text"
                      id="first-name"
                      class="form-control"
                      autocomplete="given-name"
                      placeholder="First name"
                    />
                  </div>
                  <div class="form-group">
                    <label>Last Name</label>
                    <input
                      type="text"
                      id="last-name"
                      class="form-control"
                      autocomplete="family-name"
                      placeholder="Last name"
                    />
                  </div>

                  <div class="form-group">
                    <label>Business Name</label>
                    <input
                      type="text"
                      id="business-name"
                      class="form-control"
                      placeholder="Business name (optional)"
                    />
                  </div>

                  <div class="form-group">
                    <label>Email Address</label>
                    <input
                      type="email"
                      id="email"
                      class="form-control"
                      autocomplete="email"
                      disabled
                      style="background: #f9f9f9"
                    />
                  </div>
                  <div class="form-group">
                    <label>Phone Number</label>
                    <input
                      type="tel"
                      id="phone"
                      class="form-control"
                      autocomplete="tel"
                      placeholder="Phone number"
                    />
                  </div>
                </div>

                <div class="form-group" style="margin-top: 20px">
                  <label>Bio / Description</label>
                  <textarea
                    class="form-control"
                    rows="4"
                    id="bio"
                    placeholder="Tell customers about your experience, skills, and services..."
                  ></textarea>
                </div>

                <div class="form-grid" style="margin-top: 20px">
                  <div class="form-group">
                    <label>City</label>
                    <input
                      type="text"
                      id="city"
                      class="form-control"
                      autocomplete="address-level2"
                      placeholder="City"
                    />
                  </div>
                  <div class="form-group">
                    <label>State / Region</label>
                    <input
                      type="text"
                      id="state"
                      class="form-control"
                      autocomplete="address-level1"
                      placeholder="State/Region"
                    />
                  </div>
                  <div class="form-group">
                    <label>Zip Code</label>
                    <input
                      type="text"
                      id="zip-code"
                      class="form-control"
                      autocomplete="postal-code"
                      placeholder="Zip"
                    />
                  </div>
                  <div class="form-group">
                    <label>Country</label>
                    <input
                      type="text"
                      id="country"
                      class="form-control"
                      autocomplete="country-name"
                      placeholder="Country"
                    />
                  </div>
                </div>

                <div class="form-group" style="margin-top: 20px">
                  <label>Address</label>
                  <input
                    type="text"
                    id="address"
                    class="form-control"
                    autocomplete="street-address"
                    placeholder="Address"
                  />
                </div>

                <div
                  class="settings-card"
                  style="
                    margin-top: 20px;
                    padding: 0;
                    box-shadow: none;
                    background: transparent;
                  "
                >
                  <h2 style="margin: 0 0 10px 0">Professional Details</h2>
                </div>

                <div class="form-grid">
                  <div class="form-group">
                    <label>Specialization</label>
                    <input
                      type="text"
                      id="specialization"
                      class="form-control"
                      placeholder="e.g. Cleaning, Plumbing, Electrical..."
                    />
                  </div>
                  <div class="form-group">
                    <label>Experience (years)</label>
                    <input
                      type="number"
                      id="experience-years"
                      class="form-control"
                      min="0"
                      step="1"
                      placeholder="0"
                    />
                  </div>
                  <div class="form-group">
                    <label>Languages Spoken</label>
                    <input
                      type="text"
                      id="languages-spoken"
                      class="form-control"
                      placeholder="e.g. Arabic, French, English"
                    />
                  </div>
                  <div class="form-group">
                    <label>Service Radius (km)</label>
                    <input
                      type="number"
                      id="service-radius"
                      class="form-control"
                      min="0"
                      step="1"
                      placeholder="10"
                    />
                  </div>
                </div>

                <div class="form-grid" style="margin-top: 20px">
                  <div class="form-group">
                    <label>Date of Birth</label>
                    <input
                      type="date"
                      id="date-of-birth"
                      class="form-control"
                    />
                  </div>
                  <div class="form-group">
                    <label>Gender</label>
                    <select id="gender" class="form-control">
                      <option value="">Select gender</option>
                      <option value="male">Male</option>
                      <option value="female">Female</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label>Provider Type</label>
                    <select id="provider-type" class="form-control">
                      <option value="freelancer">Freelancer</option>
                      <option value="self_employed">Self Employed</option>
                      <option value="company">Company</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label>Availability Status</label>
                    <select id="availability-status" class="form-control">
                      <option value="available">Available</option>
                      <option value="busy">Busy</option>
                      <option value="offline">Offline</option>
                    </select>
                  </div>
                </div>

                <div class="form-group" style="margin-top: 20px">
                  <label>Certification</label>
                  <input
                    type="text"
                    id="certification"
                    class="form-control"
                    placeholder="Certifications (optional)"
                  />
                </div>

                <div
                  class="settings-card"
                  style="
                    margin-top: 20px;
                    padding: 0;
                    box-shadow: none;
                    background: transparent;
                  "
                >
                  <h2 style="margin: 0 0 10px 0">Business Info (Optional)</h2>
                </div>

                <div class="form-grid">
                  <div class="form-group">
                    <label>Commercial Registry Number</label>
                    <input
                      type="text"
                      id="commercial-registry-number"
                      class="form-control"
                      placeholder="Commercial registry number"
                    />
                  </div>
                  <div class="form-group">
                    <label>NIF</label>
                    <input
                      type="text"
                      id="nif"
                      class="form-control"
                      placeholder="NIF"
                    />
                  </div>
                  <div class="form-group">
                    <label>NIS</label>
                    <input
                      type="text"
                      id="nis"
                      class="form-control"
                      placeholder="NIS"
                    />
                  </div>
                  <div class="form-group">
                    <label>Preferred Language</label>
                    <select id="preferred-language" class="form-control">
                      <option value="en">English</option>
                      <option value="fr">French</option>
                      <option value="ar">Arabic</option>
                    </select>
                  </div>
                </div>

                <div style="margin-top: 30px; text-align: right">
                  <button type="submit" class="btn-save" id="profile-save-btn">
                    Save Changes
                  </button>
                </div>
              </form>
            </div>

            <div class="settings-card">
              <h2>Password & Security</h2>
              <form id="password-form">
                <div class="form-group">
                  <label>Current Password</label>
                  <input
                    type="password"
                    id="current-password"
                    class="form-control"
                    autocomplete="current-password"
                  />
                </div>
                <div class="form-grid" style="margin-top: 20px">
                  <div class="form-group">
                    <label>New Password</label>
                    <input
                      type="password"
                      id="new-password"
                      class="form-control"
                      autocomplete="new-password"
                    />
                  </div>
                  <div class="form-group">
                    <label>Confirm New Password</label>
                    <input
                      type="password"
                      id="confirm-password"
                      class="form-control"
                      autocomplete="new-password"
                    />
                  </div>
                </div>
                <div style="margin-top: 30px">
                  <button
                    type="submit"
                    class="btn btn-outline"
                    id="password-save-btn"
                  >
                    Update Password
                  </button>
                </div>
              </form>
            </div>
          </main>
        </div>
      </div>
    </div>

    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/provider-ui.js"></script>
    <script src="../assets/js/main.js"></script>
    <script>
      const ProviderSettings = {
        els: {
          profileForm: null,
          passwordForm: null,

          firstName: null,
          lastName: null,
          businessName: null,
          email: null,
          phone: null,
          bio: null,
          address: null,

          city: null,
          state: null,
          zipCode: null,
          country: null,

          specialization: null,
          experienceYears: null,
          languagesSpoken: null,
          serviceRadius: null,
          dateOfBirth: null,
          gender: null,
          providerType: null,
          availabilityStatus: null,
          certification: null,
          commercialRegistryNumber: null,
          nif: null,
          nis: null,
          preferredLanguage: null,

          profilePictureUrl: null,
          removePhotoBtn: null,
          photoUploadStatus: null,

          profileSaveBtn: null,
          passwordSaveBtn: null,

          changePhotoBtn: null,
          photoInput: null,
          settingsAvatar: null,
        },

        state: {
          uploadedProfileUrl: null,
        },

        cacheEls() {
          this.els.profileForm = document.getElementById("profile-form");
          this.els.passwordForm = document.getElementById("password-form");

          this.els.firstName = document.getElementById("first-name");
          this.els.lastName = document.getElementById("last-name");
          this.els.businessName = document.getElementById("business-name");
          this.els.email = document.getElementById("email");
          this.els.phone = document.getElementById("phone");
          this.els.bio = document.getElementById("bio");
          this.els.address = document.getElementById("address");

          this.els.city = document.getElementById("city");
          this.els.state = document.getElementById("state");
          this.els.zipCode = document.getElementById("zip-code");
          this.els.country = document.getElementById("country");

          this.els.specialization = document.getElementById("specialization");
          this.els.experienceYears =
            document.getElementById("experience-years");
          this.els.languagesSpoken =
            document.getElementById("languages-spoken");
          this.els.serviceRadius = document.getElementById("service-radius");
          this.els.dateOfBirth = document.getElementById("date-of-birth");
          this.els.gender = document.getElementById("gender");
          this.els.providerType = document.getElementById("provider-type");
          this.els.availabilityStatus = document.getElementById(
            "availability-status",
          );
          this.els.certification = document.getElementById("certification");
          this.els.commercialRegistryNumber = document.getElementById(
            "commercial-registry-number",
          );
          this.els.nif = document.getElementById("nif");
          this.els.nis = document.getElementById("nis");
          this.els.preferredLanguage =
            document.getElementById("preferred-language");

          this.els.profilePictureUrl = document.getElementById(
            "profile-picture-url",
          );
          this.els.removePhotoBtn = document.getElementById("remove-photo-btn");
          this.els.photoUploadStatus = document.getElementById(
            "photo-upload-status",
          );

          this.els.profileSaveBtn = document.getElementById("profile-save-btn");
          this.els.passwordSaveBtn =
            document.getElementById("password-save-btn");

          this.els.changePhotoBtn = document.getElementById("change-photo-btn");
          this.els.photoInput = document.getElementById("profile-photo-input");
          this.els.settingsAvatar = document.getElementById("settings-avatar");
        },

        _setPhotoStatus(text, isError = false) {
          if (!this.els.photoUploadStatus) return;
          this.els.photoUploadStatus.textContent = text || "";
          this.els.photoUploadStatus.style.color = isError
            ? "#b91c1c"
            : "#6b7280";
        },

        _getProfilePictureUrl() {
          const fromUpload = this.state.uploadedProfileUrl;
          if (fromUpload) return fromUpload;
          const fromInput = this.els.profilePictureUrl
            ? this.els.profilePictureUrl.value.trim()
            : "";
          return fromInput || null;
        },

        async _getCloudinarySignature(folder) {
          const token = Auth.getToken();
          const url = `/backend/api/v1/uploads/cloudinary-signature?folder=${encodeURIComponent(
            folder,
          )}`;
          const res = await fetch(url, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const json = await res.json().catch(() => null);
          if (!res.ok || !json || !json.success) {
            const msg =
              json?.message || `Failed to get upload signature (${res.status})`;
            const missing = json?.errors?.missing;
            if (Array.isArray(missing) && missing.length) {
              throw new Error(`${msg}. Missing: ${missing.join(", ")}`);
            }
            throw new Error(msg);
          }
          return json.data;
        },

        async _uploadProfilePhotoToCloudinary(file) {
          const sig = await this._getCloudinarySignature(
            "moueene/provider-profile",
          );

          const endpoint = `https://api.cloudinary.com/v1_1/${encodeURIComponent(
            sig.cloud_name,
          )}/${encodeURIComponent(sig.resource_type || "image")}/upload`;

          const form = new FormData();
          form.append("file", file);
          form.append("api_key", sig.api_key);
          form.append("timestamp", String(sig.timestamp));
          form.append("signature", sig.signature);
          form.append("folder", sig.folder);

          const res = await fetch(endpoint, {
            method: "POST",
            body: form,
          });

          const json = await res.json().catch(() => null);
          if (!res.ok || !json || !json.secure_url) {
            throw new Error(json?.error?.message || "Upload failed");
          }

          return { url: json.secure_url, public_id: json.public_id };
        },

        async init() {
          if (!Auth.requireAuth()) return;
          if (!Auth.requireUserType("provider")) return;

          this.cacheEls();

          if (window.ProviderUI) {
            await ProviderUI.loadAndApply();
          }

          await this.loadProfile();
          this.setupHeaderMenu();
          this.setupForms();
          this.setupPhotoPreview();
        },

        async loadProfile() {
          try {
            const token = Auth.getToken();
            const res = await fetch("/backend/api/v1/providers/profile", {
              headers: { Authorization: `Bearer ${token}` },
            });

            const result = await res.json().catch(() => null);
            if (!res.ok || !result || !result.success) {
              throw new Error(result?.message || "Failed to load profile");
            }

            const p = result.data || {};

            // Persist for other pages
            Auth.setUser(p, "provider");

            // Populate form
            this.els.firstName.value = p.first_name || "";
            this.els.lastName.value = p.last_name || "";
            if (this.els.businessName)
              this.els.businessName.value = p.business_name || "";
            this.els.email.value = p.email || "";
            this.els.phone.value = p.phone || "";
            this.els.bio.value = p.bio || "";
            this.els.address.value = p.address || "";

            if (this.els.city) this.els.city.value = p.city || "";
            if (this.els.state) this.els.state.value = p.state || "";
            if (this.els.zipCode) this.els.zipCode.value = p.zip_code || "";
            if (this.els.country) this.els.country.value = p.country || "";

            if (this.els.specialization)
              this.els.specialization.value = p.specialization || "";
            if (this.els.experienceYears)
              this.els.experienceYears.value =
                p.experience_years !== null && p.experience_years !== undefined
                  ? String(p.experience_years)
                  : "";
            if (this.els.languagesSpoken)
              this.els.languagesSpoken.value = p.languages_spoken || "";
            if (this.els.serviceRadius)
              this.els.serviceRadius.value =
                p.service_radius !== null && p.service_radius !== undefined
                  ? String(p.service_radius)
                  : "";
            if (this.els.dateOfBirth)
              this.els.dateOfBirth.value = p.date_of_birth || "";
            if (this.els.gender) this.els.gender.value = p.gender || "";
            if (this.els.providerType)
              this.els.providerType.value = p.provider_type || "freelancer";
            if (this.els.availabilityStatus)
              this.els.availabilityStatus.value =
                p.availability_status || "offline";
            if (this.els.certification)
              this.els.certification.value = p.certification || "";
            if (this.els.commercialRegistryNumber)
              this.els.commercialRegistryNumber.value =
                p.commercial_registry_number || "";
            if (this.els.nif) this.els.nif.value = p.nif || "";
            if (this.els.nis) this.els.nis.value = p.nis || "";
            if (this.els.preferredLanguage)
              this.els.preferredLanguage.value = p.preferred_language || "en";

            if (this.els.profilePictureUrl) {
              this.els.profilePictureUrl.value = p.profile_picture || "";
            }

            // Keep avatar preview in sync
            if (this.els.settingsAvatar && p.profile_picture) {
              this.els.settingsAvatar.src = p.profile_picture;
            }

            // Re-apply header/sidebar names + avatar with freshest data
            if (window.ProviderUI) {
              await ProviderUI.loadAndApply();
            }
          } catch (err) {
            console.error("Failed to load provider profile:", err);
            await Auth.showModal({
              type: "error",
              title: "Profile load failed",
              message:
                "Could not load your profile data. Please refresh the page.",
            });
          }
        },

        setupHeaderMenu() {
          const userMenu = document.getElementById("user-menu");
          if (userMenu) {
            userMenu
              .querySelector(".user-menu-trigger")
              .addEventListener("click", (e) => {
                e.stopPropagation();
                userMenu.classList.toggle("active");
              });
            document.addEventListener("click", () => {
              userMenu.classList.remove("active");
            });
          }

          const logoutBtn = document.getElementById("logout-btn");
          const headerLogoutBtn = document.getElementById("header-logout-btn");

          if (logoutBtn) {
            logoutBtn.addEventListener("click", async (e) => {
              e.preventDefault();
              await Auth.logout();
            });
          }
          if (headerLogoutBtn) {
            headerLogoutBtn.addEventListener("click", async (e) => {
              e.preventDefault();
              await Auth.logout();
            });
          }
        },

        setupForms() {
          if (this.els.profileForm) {
            this.els.profileForm.addEventListener("submit", (e) => {
              e.preventDefault();
              this.saveProfile();
            });
          }

          if (this.els.passwordForm) {
            this.els.passwordForm.addEventListener("submit", (e) => {
              e.preventDefault();
              this.changePassword();
            });
          }
        },

        async saveProfile() {
          const photoUrl = this._getProfilePictureUrl();
          const payload = {
            first_name: this.els.firstName.value.trim(),
            last_name: this.els.lastName.value.trim(),
            business_name: this.els.businessName
              ? this.els.businessName.value.trim()
              : undefined,
            phone: this.els.phone.value.trim(),
            bio: this.els.bio.value.trim(),
            address: this.els.address.value.trim(),
            city: this.els.city ? this.els.city.value.trim() : undefined,
            state: this.els.state ? this.els.state.value.trim() : undefined,
            zip_code: this.els.zipCode
              ? this.els.zipCode.value.trim()
              : undefined,
            country: this.els.country
              ? this.els.country.value.trim()
              : undefined,
            specialization: this.els.specialization
              ? this.els.specialization.value.trim()
              : undefined,
            experience_years: this.els.experienceYears
              ? Number(this.els.experienceYears.value || 0)
              : undefined,
            languages_spoken: this.els.languagesSpoken
              ? this.els.languagesSpoken.value.trim()
              : undefined,
            service_radius: this.els.serviceRadius
              ? Number(this.els.serviceRadius.value || 0)
              : undefined,
            date_of_birth: this.els.dateOfBirth
              ? this.els.dateOfBirth.value || null
              : undefined,
            gender: this.els.gender ? this.els.gender.value || null : undefined,
            provider_type: this.els.providerType
              ? this.els.providerType.value
              : undefined,
            availability_status: this.els.availabilityStatus
              ? this.els.availabilityStatus.value
              : undefined,
            certification: this.els.certification
              ? this.els.certification.value.trim()
              : undefined,
            commercial_registry_number: this.els.commercialRegistryNumber
              ? this.els.commercialRegistryNumber.value.trim()
              : undefined,
            nif: this.els.nif ? this.els.nif.value.trim() : undefined,
            nis: this.els.nis ? this.els.nis.value.trim() : undefined,
            preferred_language: this.els.preferredLanguage
              ? this.els.preferredLanguage.value
              : undefined,
            profile_picture: photoUrl || null,
          };

          // Remove undefined keys so we don't accidentally overwrite
          Object.keys(payload).forEach((k) => {
            if (payload[k] === undefined) delete payload[k];
          });

          const btn = this.els.profileSaveBtn;
          const prevText = btn ? btn.textContent : null;

          try {
            if (btn) {
              btn.disabled = true;
              btn.textContent = "Saving...";
            }

            const token = Auth.getToken();
            const res = await fetch("/backend/api/v1/providers/profile", {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify(payload),
            });

            const result = await res.json().catch(() => null);
            if (!res.ok || !result || !result.success) {
              throw new Error(result?.message || "Failed to update profile");
            }

            // Update local state + UI
            Auth.setUser(result.data, "provider");
            if (window.ProviderUI) {
              await ProviderUI.loadAndApply();
            }

            await Auth.showModal({
              type: "success",
              title: "Saved",
              message: result.message || "Profile updated successfully.",
            });
          } catch (err) {
            console.error("Profile update failed:", err);
            await Auth.showModal({
              type: "error",
              title: "Save failed",
              message: err.message || "Failed to update profile.",
            });
          } finally {
            if (btn) {
              btn.disabled = false;
              btn.textContent = prevText;
            }
          }
        },

        async changePassword() {
          const currentPassword = document
            .getElementById("current-password")
            .value.trim();
          const newPassword = document.getElementById("new-password").value;
          const confirmPassword =
            document.getElementById("confirm-password").value;

          if (!currentPassword || !newPassword || !confirmPassword) {
            await Auth.showModal({
              type: "warning",
              title: "Missing fields",
              message: "Please fill in all password fields.",
            });
            return;
          }

          if (newPassword.length < 8) {
            await Auth.showModal({
              type: "warning",
              title: "Password too short",
              message: "New password must be at least 8 characters.",
            });
            return;
          }

          if (newPassword !== confirmPassword) {
            await Auth.showModal({
              type: "warning",
              title: "Passwords do not match",
              message: "Confirm password must match new password.",
            });
            return;
          }

          const btn = this.els.passwordSaveBtn;
          const prevText = btn ? btn.textContent : null;

          try {
            if (btn) {
              btn.disabled = true;
              btn.textContent = "Updating...";
            }

            const token = Auth.getToken();
            const res = await fetch(
              "/backend/api/v1/providers/change-password",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({
                  current_password: currentPassword,
                  new_password: newPassword,
                  confirm_password: confirmPassword,
                }),
              },
            );

            const result = await res.json().catch(() => null);
            if (!res.ok || !result || !result.success) {
              throw new Error(result?.message || "Failed to change password");
            }

            this.els.passwordForm.reset();
            await Auth.showModal({
              type: "success",
              title: "Password updated",
              message: result.message || "Password changed successfully.",
            });
          } catch (err) {
            console.error("Password change failed:", err);
            await Auth.showModal({
              type: "error",
              title: "Update failed",
              message: err.message || "Failed to change password.",
            });
          } finally {
            if (btn) {
              btn.disabled = false;
              btn.textContent = prevText;
            }
          }
        },

        setupPhotoPreview() {
          if (!this.els.changePhotoBtn || !this.els.photoInput) return;

          this.els.changePhotoBtn.addEventListener("click", () => {
            this.els.photoInput.click();
          });

          if (this.els.removePhotoBtn) {
            this.els.removePhotoBtn.addEventListener("click", () => {
              this.state.uploadedProfileUrl = null;
              if (this.els.profilePictureUrl)
                this.els.profilePictureUrl.value = "";
              this._setPhotoStatus(
                "Photo removed. Click Save Changes to apply.",
              );

              // Reset preview back to default avatar
              const fallback = "../assets/images/default-avatar.jpg";
              if (this.els.settingsAvatar)
                this.els.settingsAvatar.src = fallback;
            });
          }

          this.els.photoInput.addEventListener("change", async () => {
            const file = this.els.photoInput.files?.[0];
            if (!file) return;

            // Client-side validation
            const maxBytes = 2 * 1024 * 1024;
            if (file.size > maxBytes) {
              this._setPhotoStatus("File too large (max 2MB).", true);
              await Auth.showModal({
                type: "warning",
                title: "File too large",
                message: "Please choose an image under 2MB.",
              });
              return;
            }

            // Preview immediately
            const localUrl = URL.createObjectURL(file);
            if (this.els.settingsAvatar) this.els.settingsAvatar.src = localUrl;
            this._setPhotoStatus("Uploading photo");

            try {
              const uploaded = await this._uploadProfilePhotoToCloudinary(file);
              this.state.uploadedProfileUrl = uploaded.url;
              if (this.els.profilePictureUrl) {
                this.els.profilePictureUrl.value = uploaded.url;
              }
              this._setPhotoStatus(
                "Photo uploaded. Click Save Changes to apply.",
              );
            } catch (e) {
              console.error("Photo upload failed:", e);
              this.state.uploadedProfileUrl = null;
              this._setPhotoStatus(
                e.message || "Upload failed. Please try again.",
                true,
              );
              await Auth.showModal({
                type: "warning",
                title: "Upload failed",
                message:
                  e.message || "Could not upload the photo. Please try again.",
              });
            }
          });
        },
      };

      document.addEventListener("DOMContentLoaded", () => {
        ProviderSettings.init();
      });
    </script>
  </body>
</html>
