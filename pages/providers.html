<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Providers - Moueene</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet" />
    <link rel="stylesheet" href="../assets/css/style.css" />
    <style>
      :root {
        --glass-bg: rgba(255, 255, 255, 0.95);
      }

      body {
        background: #f8f9fa;
        padding-top: 80px;
      }

      /* Hero Section */
      .page-hero {
        background:
          linear-gradient(
            135deg,
            rgba(0, 201, 167, 0.9),
            rgba(255, 89, 148, 0.85)
          ),
          url("../assets/images/hero_provider.webp");
        background-size: cover;
        background-position: center;
        padding: 80px 0;
        color: white;
        text-align: center;
        margin-bottom: 3rem;
        border-radius: 0 0 50px 50px;
        position: relative;
        overflow: hidden;
      }

      .page-hero::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: url("../assets/pattern-white.png");
        opacity: 0.1;
      }

      .page-hero h1 {
        font-size: 3rem;
        margin-bottom: 1rem;
        font-weight: 700;
      }

      .page-hero p {
        font-size: 1.1rem;
        opacity: 0.9;
        max-width: 600px;
        margin: 0 auto;
      }

      /* Layout */
      .services-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
        display: grid;
        grid-template-columns: 280px 1fr;
        gap: 2rem;
      }

      /* Filters Sidebar */
      .filters-sidebar {
        background: white;
        padding: 1.5rem;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        height: fit-content;
        position: sticky;
        top: 100px;
      }

      .filter-group {
        margin-bottom: 1.5rem;
      }

      .filter-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .filter-option {
        display: flex;
        align-items: center;
        margin-bottom: 0.5rem;
        cursor: pointer;
        color: var(--text-light);
        transition: color 0.3s;
      }

      .filter-option:hover {
        color: var(--primary);
      }

      .filter-checkbox {
        margin-right: 0.8rem;
        accent-color: var(--primary);
        width: 18px;
        height: 18px;
      }

      .search-input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 8px;
        outline: none;
        transition: border-color 0.3s;
      }

      .search-input:focus {
        border-color: var(--primary);
      }

      /* Providers Grid */
      .providers-grid-layout {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
      }

      /* Modern Provider Card Design - Redesigned */
      .provider-card {
        background: white;
        border-radius: 24px;
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.04);
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        display: flex;
        flex-direction: column;
        border: 1px solid rgba(0, 0, 0, 0.03);
        position: relative;
        height: 100%;
        text-decoration: none; /* Ensure no underline for anchor */
        color: inherit; /* Inherit text color */
      }

      .provider-card:hover {
        transform: translateY(-10px);
        box-shadow: 0 20px 60px rgba(0, 201, 167, 0.15);
      }

      .card-header-bg {
        height: 110px;
        background: linear-gradient(
          135deg,
          rgba(0, 201, 167, 0.15) 0%,
          rgba(0, 201, 167, 0.05) 100%
        );
        position: relative;
        width: 100%;
      }

      .card-header-bg::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%2300c9a7' fill-opacity='0.1' fill-rule='evenodd'%3E%3Ccircle cx='3' cy='3' r='3'/%3E%3Ccircle cx='13' cy='13' r='3'/%3E%3C/g%3E%3C/svg%3E");
        opacity: 0.6;
      }

      .provider-avatar-wrapper {
        width: 120px;
        height: 120px;
        margin: -60px auto 1rem;
        position: relative;
        z-index: 2;
      }

      .provider-avatar-lg {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
        border: 5px solid white;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        background: white;
        transition: transform 0.3s ease;
      }

      .provider-card:hover .provider-avatar-lg {
        transform: scale(1.05);
      }

      .badge-verified-float {
        position: absolute;
        top: 15px;
        right: 15px;
        background: white;
        color: var(--primary);
        padding: 6px 14px;
        border-radius: 50px;
        font-size: 0.75rem;
        font-weight: 700;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
        display: flex;
        align-items: center;
        gap: 6px;
        z-index: 3;
      }

      .badge-pending-float {
        position: absolute;
        top: 15px;
        right: 15px;
        background: white;
        color: #f59e0b;
        padding: 6px 14px;
        border-radius: 50px;
        font-size: 0.75rem;
        font-weight: 700;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
        display: flex;
        align-items: center;
        gap: 6px;
        z-index: 3;
      }

      .card-body {
        padding: 0 1.5rem 2rem;
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .provider-name {
        font-size: 1.4rem;
        font-weight: 800;
        color: #2d3748;
        margin-bottom: 0.35rem;
        letter-spacing: -0.5px;
      }

      .provider-specialty {
        color: var(--primary);
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 0.75rem;
        background: rgba(0, 201, 167, 0.1);
        padding: 6px 16px;
        border-radius: 100px;
        display: inline-block;
      }

      .provider-location {
        font-size: 0.9rem;
        color: #718096;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .provider-stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        width: 100%;
        gap: 15px;
        margin-bottom: 1.5rem;
        background: #f8fafc;
        padding: 15px;
        border-radius: 16px;
        border: 1px solid #edf2f7;
      }

      .stat-box {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      .stat-box.border-right {
        border-right: 1px solid #e2e8f0;
      }

      .stat-value {
        display: flex;
        align-items: center;
        gap: 4px;
        font-weight: 800;
        font-size: 1.2rem;
        color: #2d3748;
        line-height: 1;
        margin-bottom: 4px;
      }

      .stat-value i {
        color: #fbbf24;
        font-size: 0.9em;
      }

      .stat-label {
        font-size: 0.75rem;
        color: #a0aec0;
        font-weight: 600;
      }

      .provider-bio-short {
        font-size: 0.95rem;
        color: #718096;
        line-height: 1.6;
        text-align: center;
        margin-bottom: 1.5rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        max-width: 90%;
      }

      /* Mobile Filter Toggle */
      .filter-toggle {
        display: none;
        width: 100%;
        padding: 1rem;
        background: white;
        border: none;
        border-radius: 8px;
        margin-bottom: 1rem;
        font-weight: 600;
        color: var(--text);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      @media (max-width: 992px) {
        .services-container {
          grid-template-columns: 1fr;
        }

        .filters-sidebar {
          display: none;
        }

        .filters-sidebar.active {
          display: block;
          animation: slideDown 0.3s ease;
        }

        .filter-toggle {
          display: block;
        }
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header class="header bg-white shadow-sm">
      <div class="container">
        <nav class="navbar">
          <a href="../index.html" class="logo">
            <img src="../logo.png" alt="Moueene" />
          </a>
          <ul class="nav-menu">
            <li><a href="../index.html">Home</a></li>
            <li><a href="services.html">Services</a></li>
            <li><a href="providers.html" class="active">Providers</a></li>
            <li><a href="how-it-works.html">How It Works</a></li>
            <li><a href="about.html">About Us</a></li>
            <li><a href="contact.html">Contact</a></li>
          </ul>
          <div class="nav-buttons">
            <a href="login.html" class="btn btn-outline">Login</a>
            <a href="register.html" class="btn btn-primary">Sign Up</a>
          </div>
          <div class="hamburger">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </nav>
      </div>
    </header>

    <!-- Hero Section -->
    <section class="page-hero">
      <div class="container">
        <h1 data-aos="fade-up">Trusted Providers</h1>
        <p data-aos="fade-up" data-aos-delay="100">
          Connect with background-checked and highly rated professionals.
        </p>
      </div>
    </section>

    <!-- Main Content -->
    <div class="services-container">
      <!-- Filters Sidebar -->
      <button class="filter-toggle">
        <i class="fas fa-filter"></i> Show Filters
      </button>

      <aside class="filters-sidebar">
        <div class="filter-group">
          <div class="filter-title">Location</div>
          <input
            id="providers-city"
            type="text"
            class="search-input"
            placeholder="Enter zip or city"
          />
        </div>

        <div class="filter-group">
          <div class="filter-title">Search</div>
          <input
            id="providers-search"
            type="text"
            class="search-input"
            placeholder="Search providers..."
          />
        </div>

        <div class="filter-group">
          <div class="filter-title">Availability</div>
          <label class="filter-option">
            <input type="checkbox" class="filter-checkbox" /> Available Now
          </label>
          <label class="filter-option">
            <input type="checkbox" class="filter-checkbox" /> Weekends
          </label>
          <label class="filter-option">
            <input type="checkbox" class="filter-checkbox" /> Evenings
          </label>
        </div>

        <div class="filter-group">
          <div class="filter-title">Specialty</div>
          <label class="filter-option">
            <input
              type="radio"
              name="specialty"
              class="filter-checkbox"
              value=""
              checked
            />
            All Services
          </label>
          <label class="filter-option">
            <input
              type="radio"
              name="specialty"
              class="filter-checkbox"
              value="Childcare"
            />
            Childcare
          </label>
          <label class="filter-option">
            <input
              type="radio"
              name="specialty"
              class="filter-checkbox"
              value="Tutoring"
            />
            Tutoring
          </label>
          <label class="filter-option">
            <input
              type="radio"
              name="specialty"
              class="filter-checkbox"
              value="Cleaning"
            />
            Cleaning
          </label>
          <label class="filter-option">
            <input
              type="radio"
              name="specialty"
              class="filter-checkbox"
              value="Pet"
            />
            Pet Care
          </label>
        </div>

        <div class="filter-group">
          <div class="filter-title">Rating</div>
          <label class="filter-option">
            <input
              type="radio"
              name="rating"
              class="filter-checkbox"
              value="4.5"
            />
            4.5 & up
          </label>
          <label class="filter-option">
            <input
              type="radio"
              name="rating"
              class="filter-checkbox"
              value="4.0"
            />
            4.0 & up
          </label>
          <label class="filter-option">
            <input
              type="radio"
              name="rating"
              class="filter-checkbox"
              value=""
              checked
            />
            Any
          </label>
        </div>

        <button id="apply-filters" class="btn btn-primary w-100">
          Apply Filters
        </button>
      </aside>

      <!-- Providers List -->
      <div>
        <div id="providers-status" style="margin-bottom: 1rem"></div>
        <div id="providers-grid" class="providers-grid-layout"></div>
        <div class="text-center mt-40" style="margin-top: 2rem">
          <button id="load-more" class="btn btn-outline" style="display: none">
            Load More
          </button>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="../assets/js/main.js"></script>
    <script>
      AOS.init({
        duration: 800,
        once: true,
      });

      // Toggle filters on mobile
      document.querySelector(".filter-toggle").addEventListener("click", () => {
        document.querySelector(".filters-sidebar").classList.toggle("active");
      });

      (function () {
        const API_BASE = "/backend/api/v1";

        const state = {
          page: 1,
          limit: 12,
          hasMore: false,
          loading: false,
        };

        const elements = {
          city: document.getElementById("providers-city"),
          search: document.getElementById("providers-search"),
          apply: document.getElementById("apply-filters"),
          grid: document.getElementById("providers-grid"),
          status: document.getElementById("providers-status"),
          loadMore: document.getElementById("load-more"),
          sidebar: document.querySelector(".filters-sidebar"),
        };

        function escapeHtml(text) {
          return String(text ?? "")
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/\"/g, "&quot;")
            .replace(/'/g, "&#039;");
        }

        function resolveImageUrl(rawUrl) {
          const value = String(rawUrl || "").trim();
          if (!value) return "";
          if (/^https?:\/\//i.test(value)) return value;
          if (value.startsWith("/")) return value;
          return `../${value.replace(/^\.\//, "")}`;
        }

        function formatHourlyRate(rate) {
          const value = Number(rate);
          if (!Number.isFinite(value) || value <= 0) return "—";
          return `$${value.toFixed(2).replace(/\.00$/, "")}`;
        }

        function setStatus(message, type = "") {
          if (!message) {
            elements.status.innerHTML = "";
            return;
          }
          const color = type === "error" ? "#e53e3e" : "var(--text-light)";
          elements.status.innerHTML = `<div style="color:${color}; padding: 0.5rem 0;">${escapeHtml(message)}</div>`;
        }

        async function apiGet(path, params = {}) {
          const url = new URL(API_BASE + path, window.location.origin);
          Object.entries(params).forEach(([key, value]) => {
            if (value === null || value === undefined || value === "") return;
            url.searchParams.set(key, value);
          });
          const response = await fetch(url);
          const json = await response.json().catch(() => null);
          if (!response.ok || !json || json.success !== true) {
            const message =
              json?.message || `Request failed (${response.status})`;
            throw new Error(message);
          }
          return json;
        }

        function readFilters() {
          const specialty = document.querySelector(
            'input[name="specialty"]:checked',
          )?.value;
          const ratingValue = document.querySelector(
            'input[name="rating"]:checked',
          )?.value;

          return {
            city: (elements.city.value || "").trim(),
            search: (elements.search.value || "").trim(),
            specialty: (specialty || "").trim(),
            min_rating: (ratingValue || "").trim(),
          };
        }

        function renderProviders(providers, { append }) {
          if (!append) elements.grid.innerHTML = "";

          const fragment = document.createDocumentFragment();
          providers.forEach((p, index) => {
            const card = document.createElement("a");
            card.className = "provider-card";
            card.setAttribute("data-aos", "fade-up");
            card.setAttribute("data-aos-delay", String((index % 6) * 80));

            const name =
              p.business_name ||
              `${p.first_name || ""} ${p.last_name || ""}`.trim() ||
              "Provider";
            const specialty = p.specialization || "Service Provider";
            const rating = Number(p.average_rating || 0).toFixed(1);
            const reviews = Number(p.total_reviews || 0);
            const hourly = formatHourlyRate(p.hourly_rate);
            const avatar =
              resolveImageUrl(p.profile_picture) ||
              "../assets/images/default-avatar.jpg";
            const city = p.city ? ` • ${p.city}` : "";
            const bio = p.bio || `${escapeHtml(specialty)}${escapeHtml(city)}`;

            let badgeHtml = "";
            if (p.verification_status === "verified") {
              badgeHtml = `<div class="badge-verified-float"><i class="fas fa-check-circle"></i> Verified</div>`;
            } else if (p.verification_status === "pending") {
              badgeHtml = `<div class="badge-pending-float"><i class="fas fa-clock"></i> Pending</div>`;
            }

            const profileHref = `provider-profile.html?provider_id=${encodeURIComponent(p.provider_id)}`;
            card.href = profileHref;

            card.innerHTML = `
              <div class="card-header-bg">
                ${badgeHtml}
              </div>
              
              <div class="provider-avatar-wrapper">
                <img
                  src="${escapeHtml(avatar)}"
                  alt="${escapeHtml(name)}"
                  class="provider-avatar-lg"
                  onerror="this.src = '../assets/images/default-avatar.jpg'"
                />
              </div>

              <div class="card-body">
                <h3 class="provider-name">${escapeHtml(name)}</h3>
                <span class="provider-specialty">${escapeHtml(specialty)}</span>
                
                <div class="provider-location">
                    <i class="fas fa-map-marker-alt" style="color:#e53e3e;"></i>
                    ${escapeHtml(p.city || "Available Online")}
                </div>

                <div class="provider-stats-grid">
                  <div class="stat-box border-right">
                    <span class="stat-value"><i class="fas fa-star"></i> ${escapeHtml(rating)}</span>
                    <span class="stat-label">${escapeHtml(reviews)} Reviews</span>
                  </div>
                  <div class="stat-box">
                    <span class="stat-value" style="color:#2d3748;">${escapeHtml(hourly)}</span>
                    <span class="stat-label">/ Hour</span>
                  </div>
                </div>

                <p class="provider-bio-short">${escapeHtml(bio)}</p>
              </div>
            `;

            fragment.appendChild(card);
          });

          elements.grid.appendChild(fragment);
          if (window.AOS && typeof window.AOS.refreshHard === "function") {
            window.AOS.refreshHard();
          }
        }

        async function loadProviders({ reset } = { reset: false }) {
          if (state.loading) return;
          state.loading = true;
          elements.loadMore.style.display = "none";

          try {
            if (reset) {
              state.page = 1;
              setStatus("Loading providers...");
            } else {
              setStatus("Loading more providers...");
            }

            const filters = readFilters();
            const result = await apiGet("/providers", {
              page: state.page,
              limit: state.limit,
              city: filters.city,
              search: filters.search,
              specialty: filters.specialty,
              min_rating: filters.min_rating,
            });

            const providers = Array.isArray(result.data) ? result.data : [];
            renderProviders(providers, { append: !reset });

            const shown = elements.grid.children.length;
            const total = Number(result.meta?.total || 0);
            state.hasMore = Boolean(result.meta?.has_more);

            if (shown === 0) {
              setStatus("No providers found.");
            } else {
              setStatus(
                `Showing ${shown}${total ? ` of ${total}` : ""} providers`,
              );
            }

            if (state.hasMore) {
              elements.loadMore.style.display = "inline-block";
            }
          } catch (err) {
            console.error(err);
            setStatus(err?.message || "Failed to load providers", "error");
          } finally {
            state.loading = false;
          }
        }

        function wireEvents() {
          elements.apply.addEventListener("click", (e) => {
            e.preventDefault();
            if (elements.sidebar.classList.contains("active")) {
              elements.sidebar.classList.remove("active");
            }
            loadProviders({ reset: true });
          });

          elements.search.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
              e.preventDefault();
              loadProviders({ reset: true });
            }
          });

          elements.city.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
              e.preventDefault();
              loadProviders({ reset: true });
            }
          });

          document
            .querySelectorAll('input[name="specialty"], input[name="rating"]')
            .forEach((input) => {
              input.addEventListener("change", () =>
                loadProviders({ reset: true }),
              );
            });

          elements.loadMore.addEventListener("click", () => {
            if (!state.hasMore) return;
            state.page += 1;
            loadProviders({ reset: false });
          });
        }

        function initFromUrl() {
          const params = new URLSearchParams(window.location.search);
          const q = params.get("q") || params.get("search") || "";
          if (q) elements.search.value = q;
          const city = params.get("city") || "";
          if (city) elements.city.value = city;
        }

        function init() {
          initFromUrl();
          wireEvents();
          loadProviders({ reset: true });
        }

        init();
      })();
    </script>
  </body>
</html>
