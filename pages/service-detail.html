<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/webp" href="/assets/images/logo.webp" />
    <title>Service Details - Moueene</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
    <link rel="stylesheet" href="../assets/css/style.css" />
    <style>
      :root {
        --glass-bg: rgba(255, 255, 255, 0.95);
      }

      body {
        background: #f8f9fa;
        padding-top: 80px;
      }

      /* Gallery Section */
      .service-gallery {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 0 20px;
        display: grid;
        grid-template-columns: 2fr 1fr;
        grid-template-rows: 200px 200px;
        gap: 1rem;
      }

      .gallery-item {
        border-radius: 20px;
        overflow: hidden;
        position: relative;
        cursor: pointer;
      }

      .gallery-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s;
      }

      .gallery-item:hover img {
        transform: scale(1.05);
      }

      .gallery-main {
        grid-row: 1 / span 2;
      }

      .view-all-photos {
        position: absolute;
        bottom: 20px;
        right: 20px;
        background: white;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 500;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      /* Content Layout */
      .service-content {
        max-width: 1200px;
        margin: 0 auto 4rem;
        padding: 0 20px;
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 4rem;
      }

      /* Main Column */
      .service-main h1 {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 1rem;
      }

      .service-meta {
        display: flex;
        gap: 1.5rem;
        color: var(--text-light);
        margin-bottom: 2rem;
        font-size: 0.95rem;
      }

      .service-meta span {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .rating i {
        color: #ffd700;
      }

      .description p {
        line-height: 1.8;
        color: var(--text-light);
        margin-bottom: 1.5rem;
      }

      .included-section {
        background: white;
        padding: 2rem;
        border-radius: 20px;
        margin: 2rem 0;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
      }

      .included-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-top: 1.5rem;
      }

      .feature-item {
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--text);
      }

      .feature-item i {
        color: var(--primary);
        background: rgba(0, 201, 167, 0.1);
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        font-size: 0.8rem;
      }

      /* Reviews */
      .reviews-section {
        margin-top: 3rem;
      }

      .review-card {
        background: white;
        padding: 1.5rem;
        border-radius: 20px;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.02);
      }

      .reviewer-info {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .reviewer-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
      }

      /* Sidebar */
      .service-sidebar {
        position: sticky;
        top: 100px;
        height: fit-content;
      }

      .booking-card {
        background: white;
        padding: 2rem;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(0, 0, 0, 0.05);
      }

      .price-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid #eee;
      }

      .price {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary);
      }

      .price-unit {
        font-size: 1rem;
        color: var(--text-light);
        font-weight: 400;
      }

      .booking-form .form-group {
        margin-bottom: 1.2rem;
      }

      .booking-form label {
        display: block;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        font-weight: 500;
      }

      .booking-form input {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 12px;
        font-family: inherit;
      }

      .book-btn {
        width: 100%;
        background: var(--primary);
        color: white;
        border: none;
        padding: 15px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 1rem;
        margin-top: 1rem;
        cursor: pointer;
        transition: all 0.3s;
      }

      .book-btn:hover {
        background: #00b894;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 201, 167, 0.3);
      }

      /* Provider Mini Profile */
      .provider-wiz {
        background: white;
        padding: 1.5rem;
        border-radius: 20px;
        margin-top: 2rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.03);
        text-decoration: none;
        transition: transform 0.3s;
      }

      .provider-wiz:hover {
        transform: translateY(-3px);
      }

      .prov-img {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        object-fit: cover;
      }

      .prov-info h4 {
        color: var(--text);
        margin-bottom: 0.2rem;
      }

      .prov-info p {
        color: var(--text-light);
        font-size: 0.85rem;
      }

      @media (max-width: 992px) {
        .service-content {
          grid-template-columns: 1fr;
        }
        .service-gallery {
          grid-template-rows: 250px auto;
        }
        .gallery-main {
          grid-row: 1;
          grid-column: 1 / -1;
        }
        .service-sidebar {
          position: static;
          margin-top: 3rem;
        }
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header class="header bg-white shadow-sm">
      <div class="container">
        <nav class="navbar">
          <a href="../index.html" class="logo">
            <img src="../logo.png" alt="Moueene" />
          </a>
          <ul class="nav-menu">
            <li><a href="../index.html">Home</a></li>
            <li><a href="services.html" class="active">Services</a></li>
            <li><a href="providers.html">Providers</a></li>
            <li><a href="about.html">About Us</a></li>
            <li><a href="contact.html">Contact</a></li>
          </ul>
          <div class="nav-buttons">
            <a href="login.html" class="btn btn-outline">Login</a>
            <a href="register.html" class="btn btn-primary">Sign Up</a>
          </div>
          <div class="hamburger">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </nav>
      </div>
    </header>

    <!-- Gallery -->
    <div class="service-gallery">
      <div class="gallery-item gallery-main" data-aos="fade-in">
        <img
          id="galleryMainImg"
          src="../assets/images/services/childcare1.jpg"
          onerror="
            this.src =
              'https://placehold.co/800x600/00c9a7/white?text=Main+Service+Image'
          "
          alt="Service Main"
        />
        <div class="view-all-photos">
          <i class="fas fa-th"></i> View all photos
        </div>
      </div>
      <div class="gallery-item" data-aos="fade-in" data-aos-delay="100">
        <img
          id="galleryImg1"
          src="../assets/images/services/childcare2.jpg"
          onerror="
            this.src = 'https://placehold.co/400x300/e0e0e0/555?text=Gallery+1'
          "
          alt="Service Detail"
        />
      </div>
      <div class="gallery-item" data-aos="fade-in" data-aos-delay="200">
        <img
          id="galleryImg2"
          src="../assets/images/services/childcare3.jpg"
          onerror="
            this.src = 'https://placehold.co/400x300/e0e0e0/555?text=Gallery+2'
          "
          alt="Service Detail"
        />
      </div>
    </div>

    <!-- Main Content -->
    <div class="service-content">
      <!-- Left Column -->
      <div class="service-main">
        <div class="service-header" data-aos="fade-up">
          <h1 id="serviceTitle">Professional Babysitting Service</h1>
          <div class="service-meta">
            <span class="rating" id="serviceRating"
              ><i class="fas fa-star"></i> 4.9 (127 reviews)</span
            >
            <span class="location" id="serviceLocation"
              ><i class="fas fa-map-marker-alt"></i> New York, NY</span
            >
            <span class="category" id="serviceCategory"
              ><i class="fas fa-tag"></i> Childcare</span
            >
          </div>
        </div>

        <div class="description" data-aos="fade-up" id="serviceDescription">
          <h3>About This Service</h3>
          <p>
            Looking for reliable and caring childcare? I offer professional
            babysitting services with over 10 years of experience working with
            children of all ages. My approach combines structured activities
            with free play to support your children's development while ensuring
            they have fun.
          </p>
          <p>
            I'm trained in early childhood education and hold current CPR and
            First Aid certifications. I believe in creating a safe, engaging
            environment where children feel comfortable and parents can have
            peace of mind.
          </p>
        </div>

        <div class="included-section" data-aos="fade-up">
          <h3>What's Included</h3>
          <div class="included-grid">
            <div class="feature-item">
              <i class="fas fa-check"></i> Age-appropriate activities
            </div>
            <div class="feature-item">
              <i class="fas fa-check"></i> Meal preparation
            </div>
            <div class="feature-item">
              <i class="fas fa-check"></i> Homework assistance
            </div>
            <div class="feature-item">
              <i class="fas fa-check"></i> Light housekeeping
            </div>
            <div class="feature-item">
              <i class="fas fa-check"></i> Bedtime routine
            </div>
            <div class="feature-item">
              <i class="fas fa-check"></i> Regular photo updates
            </div>
          </div>
        </div>

        <div class="reviews-section" data-aos="fade-up">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 20px;
            "
          >
            <h3>Client Reviews</h3>
            <div class="rating-summary">
              <strong>4.9</strong>
              <span style="color: #ffd700"
                ><i class="fas fa-star"></i><i class="fas fa-star"></i
                ><i class="fas fa-star"></i><i class="fas fa-star"></i
                ><i class="fas fa-star-half-alt"></i
              ></span>
            </div>
          </div>

          <div class="review-card">
            <div class="reviewer-info">
              <img
                src="../assets/images/users/user1.jpg"
                onerror="
                  this.src = 'https://placehold.co/100/e0e0e0/333?text=S'
                "
                class="reviewer-avatar"
                alt="Sarah M."
              />
              <div>
                <h4 style="margin: 0">Sarah Mitchell</h4>
                <div
                  style="font-size: 0.85rem; color: #ffd700; margin-top: 2px"
                >
                  <i class="fas fa-star"></i><i class="fas fa-star"></i
                  ><i class="fas fa-star"></i><i class="fas fa-star"></i
                  ><i class="fas fa-star"></i>
                </div>
              </div>
              <span style="margin-left: auto; font-size: 0.85rem; color: #999"
                >2 days ago</span
              >
            </div>
            <p style="color: var(--text-light)">
              Absolutely wonderful! My kids loved her and didn't want her to
              leave. Very professional and kept me updated throughout the
              evening.
            </p>
          </div>

          <div class="review-card">
            <div class="reviewer-info">
              <img
                src="../assets/images/users/user2.jpg"
                onerror="
                  this.src = 'https://placehold.co/100/e0e0e0/333?text=J'
                "
                class="reviewer-avatar"
                alt="John D."
              />
              <div>
                <h4 style="margin: 0">John Davis</h4>
                <div
                  style="font-size: 0.85rem; color: #ffd700; margin-top: 2px"
                >
                  <i class="fas fa-star"></i><i class="fas fa-star"></i
                  ><i class="fas fa-star"></i><i class="fas fa-star"></i
                  ><i class="far fa-star"></i>
                </div>
              </div>
              <span style="margin-left: auto; font-size: 0.85rem; color: #999"
                >1 week ago</span
              >
            </div>
            <p style="color: var(--text-light)">
              Great service, very punctual and polite. Handled our energetic
              toddlers with ease. Would definitely recommend.
            </p>
          </div>

          <button class="btn btn-outline" style="width: 100%; margin-top: 10px">
            Show More Reviews
          </button>
        </div>
      </div>

      <!-- Sidebar -->
      <aside class="service-sidebar" data-aos="fade-left">
        <div class="booking-card">
          <div class="price-header">
            <div>
              <span class="price" id="servicePrice">$25</span>
              <span class="price-unit" id="servicePriceUnit">/ hour</span>
            </div>
            <span
              class="badge"
              style="
                background: rgba(0, 201, 167, 0.1);
                color: var(--primary);
                padding: 5px 10px;
                border-radius: 20px;
                font-size: 0.8rem;
              "
              >Available Now</span
            >
          </div>

          <form class="booking-form" action="booking-confirmation.html">
            <div class="form-group">
              <label>Date</label>
              <div style="position: relative">
                <input type="text" id="datePicker" placeholder="Select Date" />
                <i
                  class="far fa-calendar-alt"
                  style="
                    position: absolute;
                    right: 15px;
                    top: 15px;
                    color: #999;
                  "
                ></i>
              </div>
            </div>

            <div class="form-group">
              <label>Time</label>
              <select
                class="form-control"
                style="
                  width: 100%;
                  padding: 12px;
                  border-radius: 12px;
                  border: 1px solid #ddd;
                "
              >
                <option>10:00 AM</option>
                <option>12:00 PM</option>
                <option>02:00 PM</option>
                <option>04:00 PM</option>
              </select>
            </div>

            <div class="form-group">
              <label>Duration</label>
              <select
                class="form-control"
                style="
                  width: 100%;
                  padding: 12px;
                  border-radius: 12px;
                  border: 1px solid #ddd;
                "
              >
                <option>1 Hour</option>
                <option>2 Hours</option>
                <option>3 Hours</option>
                <option>4+ Hours</option>
              </select>
            </div>

            <div
              style="
                margin: 1.5rem 0;
                border-top: 1px dashed #ddd;
                padding-top: 1rem;
              "
            >
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  margin-bottom: 0.5rem;
                  color: var(--text-light);
                "
              >
                <span>Service Fee</span>
                <span>$2.50</span>
              </div>
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  font-weight: 600;
                  font-size: 1.1rem;
                "
              >
                <span>Total</span>
                <span>$27.50</span>
              </div>
            </div>

            <button type="submit" class="book-btn">Book Appointment</button>
            <p
              style="
                text-align: center;
                font-size: 0.8rem;
                margin-top: 1rem;
                color: #999;
              "
            >
              No charge until service is confirmed.
            </p>
          </form>
        </div>

        <a href="provider-profile.html" class="provider-wiz" id="providerLink">
          <img
            src="../assets/images/providers/provider1.jpg"
            onerror="
              this.src = 'https://placehold.co/100x100/e0e0e0/333?text=P'
            "
            class="prov-img"
            alt="Provider"
            id="providerAvatar"
          />
          <div class="prov-info">
            <h4 id="providerName">Emma Wilson</h4>
            <p id="providerSubtitle">Verified Professional</p>
          </div>
          <i
            class="fas fa-chevron-right"
            style="margin-left: auto; color: #ccc"
          ></i>
        </a>
      </aside>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="../assets/js/main.js"></script>
    <script>
      AOS.init({
        duration: 800,
        once: true,
      });

      // Initialize Date Picker
      flatpickr("#datePicker", {
        minDate: "today",
        dateFormat: "F j, Y",
      });

      (function () {
        const API_BASE = "/backend/api/v1";

        const els = {
          title: document.getElementById("serviceTitle"),
          rating: document.getElementById("serviceRating"),
          location: document.getElementById("serviceLocation"),
          category: document.getElementById("serviceCategory"),
          description: document.getElementById("serviceDescription"),
          price: document.getElementById("servicePrice"),
          priceUnit: document.getElementById("servicePriceUnit"),
          imgMain: document.getElementById("galleryMainImg"),
          img1: document.getElementById("galleryImg1"),
          img2: document.getElementById("galleryImg2"),
          providerLink: document.getElementById("providerLink"),
          providerAvatar: document.getElementById("providerAvatar"),
          providerName: document.getElementById("providerName"),
          providerSubtitle: document.getElementById("providerSubtitle"),
        };

        function escapeHtml(text) {
          return String(text ?? "")
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/\"/g, "&quot;")
            .replace(/'/g, "&#039;");
        }

        function resolveImageUrl(rawUrl) {
          const value = String(rawUrl || "").trim();
          if (!value) return "";
          if (/^https?:\/\//i.test(value)) return value;
          if (value.startsWith("/")) return value;
          return `../${value.replace(/^\.\//, "")}`;
        }

        function getCategoryFallbackImage(categoryId) {
          const index = ((Number(categoryId || 1) - 1) % 6) + 1;
          return `../assets/images/categories/category${index}.jpg`;
        }

        function formatPrice(basePrice, priceType) {
          const price = Number(basePrice || 0);
          const hasFraction = Math.abs(price % 1) > 0.000001;
          const formattedNumber = new Intl.NumberFormat("fr-DZ", {
            minimumFractionDigits: hasFraction ? 2 : 0,
            maximumFractionDigits: 2,
          }).format(price);
          const formatted = `${formattedNumber} دج`;
          if (priceType === "hourly") return { value: formatted, unit: "/ hr" };
          if (priceType === "per_item")
            return { value: formatted, unit: "/ item" };
          return { value: formatted, unit: "" };
        }

        async function apiGet(path, params = {}) {
          const url = new URL(API_BASE + path, window.location.origin);
          Object.entries(params).forEach(([key, value]) => {
            if (value === null || value === undefined || value === "") return;
            url.searchParams.set(key, value);
          });
          const response = await fetch(url);
          const json = await response.json().catch(() => null);
          if (!response.ok || !json || json.success !== true) {
            const message =
              json?.message || `Request failed (${response.status})`;
            throw new Error(message);
          }
          return json;
        }

        function renderOffer(offer) {
          const serviceName = offer.service_name || "Service";
          document.title = `${serviceName} - Moueene`;
          if (els.title) els.title.textContent = serviceName;

          const rating = Number(offer.average_rating || 0);
          const reviews = Number(offer.total_reviews || 0);
          if (els.rating) {
            els.rating.innerHTML = `<i class="fas fa-star"></i> ${escapeHtml(
              rating ? rating.toFixed(1) : "0.0",
            )} (${escapeHtml(reviews)})`;
          }

          if (els.location) {
            const city = String(offer.provider_city || "").trim();
            els.location.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${escapeHtml(
              city || "",
            )}`;
          }

          if (els.category) {
            els.category.innerHTML = `<i class="fas fa-tag"></i> ${escapeHtml(
              offer.category_name || "Service",
            )}`;
          }

          if (els.description) {
            const about = String(offer.description || "").trim();
            const h3 = els.description.querySelector("h3")?.outerHTML ||
              "<h3>About This Service</h3>";
            els.description.innerHTML = `${h3}<p>${escapeHtml(about)}</p>`;
          }

          const price = formatPrice(offer.base_price, offer.price_type);
          if (els.price) els.price.textContent = price.value;
          if (els.priceUnit) els.priceUnit.textContent = price.unit;

          const imageUrl = (offer.primary_image || offer.service_image)
            ? resolveImageUrl(offer.primary_image || offer.service_image)
            : getCategoryFallbackImage(offer.category_id);
          if (els.imgMain) els.imgMain.src = imageUrl;
          if (els.img1) els.img1.src = imageUrl;
          if (els.img2) els.img2.src = imageUrl;

          const providerName = (function () {
            const business = (offer.business_name || "").trim();
            if (business) return business;
            const first = (offer.first_name || "").trim();
            const last = (offer.last_name || "").trim();
            return [first, last].filter(Boolean).join(" ") || "Provider";
          })();
          if (els.providerName) els.providerName.textContent = providerName;

          if (els.providerAvatar) {
            const avatar = offer.provider_avatar
              ? resolveImageUrl(offer.provider_avatar)
              : "../assets/images/default-avatar.jpg";
            els.providerAvatar.src = avatar;
          }

          if (els.providerLink && offer.provider_id) {
            els.providerLink.href = `provider-profile.html?provider_id=${encodeURIComponent(
              offer.provider_id,
            )}`;
          }
        }

        async function initServiceDetail() {
          const params = new URLSearchParams(window.location.search);
          const providerServiceId =
            params.get("provider_service_id") || params.get("offer_id") || "";
          if (!providerServiceId) return;

          try {
            const result = await apiGet("/services/offers", {
              provider_service_id: providerServiceId,
              limit: 1,
              page: 1,
            });
            const offer = Array.isArray(result.data) ? result.data[0] : null;
            if (!offer) throw new Error("Service not found");
            renderOffer(offer);
          } catch (e) {
            console.error(e);
            if (els.title) {
              els.title.textContent = "Service not found";
            }
            if (els.description) {
              const h3 =
                els.description.querySelector("h3")?.outerHTML ||
                "<h3>About This Service</h3>";
              els.description.innerHTML = `${h3}<p>${escapeHtml(
                e?.message || "Failed to load service details",
              )}</p>`;
            }
          }
        }

        initServiceDetail();
      })();
    </script>
  </body>
</html>
